<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tr√≠ch xu·∫•t CCCD</title>

    <!-- Favicon -->
    <link rel="icon" type="image/png" href="trich-xuat-can-cuoc-cong-dan.png">
    <link rel="shortcut icon" type="image/png" href="trich-xuat-can-cuoc-cong-dan.png">
    <link rel="apple-touch-icon" href="trich-xuat-can-cuoc-cong-dan.png">

    <!-- Open Graph Meta Tags -->
    <meta property="og:title" content="Tr√≠ch xu·∫•t CCCD">
    <meta property="og:description" content="C√¥ng c·ª• tr√≠ch xu·∫•t th√¥ng tin t·ª´ cƒÉn c∆∞·ªõc c√¥ng d√¢n">
    <meta property="og:image" content="trich-xuat-can-cuoc-cong-dan.png">
    <meta property="og:url" content="https://cancuoccongdan.web.app">
    <meta property="og:type" content="website">
    <meta property="og:site_name" content="Tr√≠ch xu·∫•t CCCD">

    <!-- Twitter Card Meta Tags -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Tr√≠ch xu·∫•t CCCD">
    <meta name="twitter:description" content="C√¥ng c·ª• tr√≠ch xu·∫•t th√¥ng tin t·ª´ cƒÉn c∆∞·ªõc c√¥ng d√¢n">
    <meta name="twitter:image" content="trich-xuat-can-cuoc-cong-dan.png">

    <!-- Additional Meta Tags -->
    <meta name="description" content="C√¥ng c·ª• tr√≠ch xu·∫•t th√¥ng tin t·ª´ cƒÉn c∆∞·ªõc c√¥ng d√¢n">
    <meta name="keywords" content="CCCD, cƒÉn c∆∞·ªõc c√¥ng d√¢n, tr√≠ch xu·∫•t, OCR, AI">
    <!-- SheetJS for Excel export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .main-content {
            flex: 1;
        }

        .header {
            color: white;
            padding: 12px 0;
            margin-bottom: 10px;
        }

        .header-main {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .header-left {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }

        .header h1 {
            font-size: 1.3rem;
            margin: 0;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .header p {
            font-size: 0.75rem;
            margin: 2px 0 0 0;
            opacity: 0.9;
        }

        .header-center {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .header-right {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .compact-stat {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            padding: 6px 10px;
            border-radius: 6px;
            text-align: center;
            min-width: 70px;
            backdrop-filter: blur(10px);
        }

        .compact-stat-number {
            font-size: 1.1rem;
            font-weight: bold;
            margin-bottom: 1px;
        }

        .compact-stat-label {
            font-size: 0.65rem;
            opacity: 0.9;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-2px);
        }

        .section-title {
            color: #4a5568;
            font-size: 1.1rem;
            margin-bottom: 12px;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 6px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2d3748;
        }

        .form-input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            display: inline-block;
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            margin: 3px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(72, 187, 120, 0.4);
        }

        .btn-warning {
            background: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%);
            color: white;
        }

        .btn-warning:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(237, 137, 54, 0.4);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn:disabled:hover {
            transform: none;
            box-shadow: none;
        }

        .file-input-wrapper {
            position: relative;
            display: inline-block;
            cursor: pointer;
            width: 100%;
        }

        .file-input {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .file-input-label {
            display: block;
            padding: 15px;
            border: 2px dashed #cbd5e0;
            border-radius: 8px;
            text-align: center;
            background: #f7fafc;
            transition: all 0.3s ease;
        }

        .compact-file-input {
            display: inline-block;
            padding: 6px 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .compact-file-input:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        /* Folder selection button styling */
        .compact-file-input.folder-btn {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
        }

        .compact-file-input.folder-btn:hover {
            box-shadow: 0 4px 12px rgba(72, 187, 120, 0.3);
        }

        .file-input-label:hover {
            border-color: #667eea;
            background: #edf2f7;
        }

        .image-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .image-item {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }

        .image-item:hover {
            transform: scale(1.05);
        }

        .image-item img {
            width: 100%;
            height: 150px;
            object-fit: cover;
        }

        .image-status {
            position: absolute;
            top: 5px;
            right: 5px;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            color: white;
        }

        .status-pending {
            background: #fbd38d;
            color: #744210;
        }

        .status-processing {
            background: #63b3ed;
            color: #2a4365;
        }

        .status-completed {
            background: #68d391;
            color: #22543d;
        }

        .status-error {
            background: #fc8181;
            color: #742a2a;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
            margin: 15px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #48bb78, #38a169);
            transition: width 0.3s ease;
            width: 0%;
        }

        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .results-table th,
        .results-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }

        .results-table th {
            background: #f7fafc;
            font-weight: 600;
            color: #2d3748;
        }

        .results-table tr:hover {
            background: #f7fafc;
        }

        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .alert-success {
            background: #c6f6d5;
            color: #22543d;
            border: 1px solid #9ae6b4;
        }

        .alert-error {
            background: #fed7d7;
            color: #742a2a;
            border: 1px solid #feb2b2;
        }

        .alert-info {
            background: #bee3f8;
            color: #2a4365;
            border: 1px solid #90cdf4;
        }

        .hidden {
            display: none;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background-color: white;
            margin: 10% auto;
            padding: 25px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            position: relative;
            animation: modalSlideIn 0.3s ease;
        }

        /* Image Preview Modal */
        .image-modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            cursor: pointer;
        }

        .image-modal-content {
            display: flex;
            height: 100%;
            align-items: center;
            justify-content: center;
            gap: 30px;
            padding: 20px;
            box-sizing: border-box;
        }

        .image-modal-left {
            flex: 1;
            max-width: 60%;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .image-modal-large {
            max-width: 100%;
            max-height: 80vh;
            object-fit: contain;
            border-radius: 10px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        }

        .image-modal-right {
            flex: 1;
            max-width: 35%;
            background: white;
            border-radius: 15px;
            padding: 25px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        .image-modal-title {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 20px;
            color: #2d3748;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 10px;
        }

        /* Modal actions */
        .modal-actions {
            margin-bottom: 20px;
            display: flex;
            justify-content: center;
        }

        .re-extract-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .re-extract-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .re-extract-btn:active {
            transform: translateY(0);
        }

        .re-extract-btn:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .re-extract-btn .btn-icon {
            font-size: 16px;
            animation: none;
        }

        .re-extract-btn:disabled .btn-icon {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        .data-row {
            display: flex;
            margin-bottom: 15px;
            align-items: flex-start;
        }

        .data-label {
            font-weight: 600;
            color: #4a5568;
            width: 120px;
            flex-shrink: 0;
            font-size: 14px;
        }

        .data-value {
            color: #2d3748;
            word-wrap: break-word;
            flex: 1;
            font-size: 14px;
            line-height: 1.4;
        }

        .data-input {
            width: 100%;
            padding: 8px 12px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s ease;
            resize: vertical;
            min-height: 36px;
        }

        .data-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
        }

        .modal-navigation {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            font-size: 24px;
            cursor: pointer;
            transition: background 0.3s ease;
            z-index: 2002;
        }

        .modal-navigation:hover {
            background: rgba(0, 0, 0, 0.9);
        }

        .modal-navigation:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .modal-navigation.prev {
            left: 20px;
        }

        .modal-navigation.next {
            right: 20px;
        }

        .modal-controls {
            margin-top: 20px;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            border-top: 1px solid #e2e8f0;
            padding-top: 15px;
        }

        .btn-modal {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-modal.edit {
            background: #ed8936;
            color: white;
        }

        .btn-modal.edit:hover {
            background: #dd6b20;
        }

        .btn-modal.save {
            background: #48bb78;
            color: white;
        }

        .btn-modal.save:hover {
            background: #38a169;
        }

        .btn-modal.cancel {
            background: #e2e8f0;
            color: #4a5568;
        }

        .btn-modal.cancel:hover {
            background: #cbd5e0;
        }

        .image-controls {
            position: absolute;
            top: 10px;
            left: 10px;
            display: flex;
            gap: 8px;
            z-index: 2003;
        }

        .rotate-btn {
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 18px;
            cursor: pointer;
            transition: background 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .rotate-btn:hover {
            background: rgba(0, 0, 0, 0.9);
        }

        .image-modal-large {
            transition: transform 0.3s ease;
        }

        .delete-confirm-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(239, 68, 68, 0.95);
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            text-align: center;
            z-index: 2004;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            animation: deleteConfirmPulse 0.6s ease-in-out;
        }

        @keyframes deleteConfirmPulse {
            0% {
                transform: translate(-50%, -50%) scale(0.8);
                opacity: 0;
            }

            50% {
                transform: translate(-50%, -50%) scale(1.1);
                opacity: 1;
            }

            100% {
                transform: translate(-50%, -50%) scale(1);
                opacity: 1;
            }
        }

        .close-modal {
            position: absolute;
            top: 20px;
            right: 30px;
            color: white;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
            z-index: 2001;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.3s ease;
        }

        .close-modal:hover {
            background: rgba(0, 0, 0, 0.8);
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            position: absolute;
            right: 15px;
            top: 10px;
            cursor: pointer;
        }

        .close:hover,
        .close:focus {
            color: #000;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .api-status {
            display: inline-flex;
            align-items: center;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            margin-left: 10px;
        }

        .api-status.connected {
            background: #c6f6d5;
            color: #22543d;
            border: 1px solid #9ae6b4;
        }

        .api-status.disconnected {
            background: #fed7d7;
            color: #742a2a;
            border: 1px solid #feb2b2;
        }

        /* Image Table Styles */
        .image-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .image-table th,
        .image-table td {
            padding: 8px 6px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
            vertical-align: middle;
        }

        .image-table th {
            background: #f7fafc;
            font-weight: 600;
            color: #2d3748;
            position: sticky;
            top: 0;
            z-index: 10;
            font-size: 0.75rem;
            line-height: 1.2;
            padding: 6px 4px;
        }

        .image-table td {
            font-size: 0.8rem;
        }

        .image-table tr:hover {
            background: #f7fafc;
        }

        .image-preview {
            width: 60px;
            height: 45px;
            object-fit: cover;
            border-radius: 4px;
            cursor: pointer;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .image-preview:hover {
            cursor: pointer;
            opacity: 0.8;
        }

        .action-menu {
            display: flex;
            gap: 3px;
        }

        .action-btn {
            padding: 4px 8px;
            border: none;
            border-radius: 3px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .action-btn.process {
            background: #48bb78;
            color: white;
        }

        .action-btn.process:hover {
            background: #38a169;
        }

        .action-btn.delete {
            background: #f56565;
            color: white;
        }

        .action-btn.delete:hover {
            background: #e53e3e;
        }

        .action-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .status-badge {
            padding: 3px 6px;
            border-radius: 8px;
            font-size: 10px;
            font-weight: bold;
            text-align: center;
            min-width: 60px;
        }

        .status-pending {
            background: #fbd38d;
            color: #744210;
        }

        .status-processing {
            background: #63b3ed;
            color: #2a4365;
        }

        .status-completed {
            background: #68d391;
            color: #22543d;
        }

        .status-error {
            background: #fc8181;
            color: #742a2a;
        }

        /* Pagination Styles */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 20px;
            gap: 10px;
        }

        .pagination button {
            padding: 8px 12px;
            border: 1px solid #e2e8f0;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .pagination button:hover:not(:disabled) {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .pagination button.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination-info {
            font-size: 14px;
            color: #666;
        }

        /* CSV Dropdown Styles */
        .csv-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            min-width: 200px;
            margin-top: 5px;
        }

        .csv-dropdown button {
            display: block;
            width: 100%;
            padding: 12px 16px;
            border: none;
            background: white;
            text-align: left;
            color: #333;
            font-size: 14px;
            cursor: pointer;
            transition: background 0.3s ease;
            border-radius: 0;
        }

        .csv-dropdown button:first-child {
            border-radius: 8px 8px 0 0;
        }

        .csv-dropdown button:last-child {
            border-radius: 0 0 8px 8px;
        }

        .csv-dropdown button:hover {
            background: #f7fafc;
            transform: none;
            box-shadow: none;
        }

        /* Table controls */
        .table-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .rows-per-page {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .rows-per-page select {
            padding: 6px 10px;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            background: white;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        /* Footer Styles */
        .footer {
            background: rgba(255, 255, 255, 0.8);
            padding: 5px 0;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            margin-top: auto;
        }

        .footer-content {
            text-align: center;
            color: #4a5568;
            font-size: 10px;
        }

        .footer-content p {
            margin: 0;
            font-weight: 400;
        }

        .footer-content .developer-name {
            color: #667eea;
            font-weight: 500;
        }

        .footer-content .phone {
            color: #48bb78;
            font-weight: 500;
            margin-left: 5px;
            text-decoration: none;
            transition: color 0.3s ease;
        }

        .footer-content .phone:hover {
            color: #38a169;
            text-decoration: underline;
        }

        .footer-content .zalo {
            color: #0068ff;
            font-weight: 500;
            margin-left: 8px;
            text-decoration: none;
            transition: color 0.3s ease;
            padding: 2px 6px;
            border-radius: 4px;
            background: rgba(0, 104, 255, 0.1);
        }

        .footer-content .zalo:hover {
            color: #0052cc;
            text-decoration: underline;
            background: rgba(0, 104, 255, 0.2);
        }

        .footer-content .donate-button-inline {
            color: #ff6b6b;
            font-weight: 500;
            margin-left: 8px;
            text-decoration: none;
            transition: all 0.3s ease;
            padding: 2px 6px;
            border-radius: 4px;
            background: rgba(255, 107, 107, 0.1);
            border: none;
            cursor: pointer;
            font-size: inherit;
            font-family: inherit;
        }

        .footer-content .donate-button-inline:hover {
            color: #ff5252;
            text-decoration: underline;
            background: rgba(255, 107, 107, 0.2);
        }


        /* Donate Modal */
        .donate-modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
        }

        .donate-modal-content {
            background: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 20px;
            width: 90%;
            max-width: 400px;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .donate-modal-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .donate-modal-title::before {
            content: "üíù";
            font-size: 1.4rem;
        }

        .donate-modal-description {
            color: #4a5568;
            font-size: 0.9rem;
            margin-bottom: 20px;
            line-height: 1.5;
        }

        .donate-qr-container {
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            margin-bottom: 15px;
        }

        .donate-qr-container img {
            max-width: 200px;
            width: 100%;
            height: auto;
            border-radius: 8px;
        }

        .donate-bank-info {
            background: #f7fafc;
            padding: 12px;
            border-radius: 8px;
            border-left: 4px solid #ff6b6b;
        }

        .donate-bank-name {
            font-weight: 600;
            color: #2d3748;
            font-size: 0.95rem;
        }

        .donate-account-info {
            color: #4a5568;
            font-size: 0.85rem;
            margin-top: 4px;
        }

        .donate-modal-actions {
            text-align: center;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #e2e8f0;
        }

        .donate-close {
            background: #6c757d;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .donate-close:hover {
            background: #5a6268;
            transform: translateY(-1px);
        }

        @media (max-width: 768px) {
            .donate-button {
                bottom: 15px;
                right: 15px;
                padding: 10px 16px;
                font-size: 0.85rem;
            }

            .donate-modal-content {
                margin: 10% auto;
                padding: 25px 20px;
            }

            .donate-qr-container img {
                max-width: 180px;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 5px 10px;
            }

            .header {
                padding: 8px 0;
            }

            .header-main {
                flex-direction: column;
                gap: 10px;
                align-items: center;
            }

            .header-left {
                align-items: center;
                text-align: center;
            }

            .header h1 {
                font-size: 1.1rem;
            }

            .header p {
                font-size: 0.7rem;
            }

            .header-center {
                gap: 6px;
                order: 3;
            }

            .header-right {
                gap: 8px;
                order: 2;
                flex-wrap: wrap;
                justify-content: center;
            }

            .compact-stat {
                padding: 4px 6px;
                min-width: 55px;
            }

            .compact-stat-number {
                font-size: 0.9rem;
            }

            .compact-stat-label {
                font-size: 0.6rem;
            }

            .compact-file-input {
                padding: 5px 10px;
                font-size: 11px;
            }

            .image-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }

            /* Mobile responsive for image modal */
            .image-modal-content {
                flex-direction: column;
                gap: 20px;
                padding: 10px;
            }

            .image-modal-left {
                max-width: 100%;
                order: 1;
            }

            .image-modal-right {
                max-width: 100%;
                max-height: 40vh;
                order: 2;
                padding: 15px;
            }

            .image-modal-large {
                max-height: 50vh;
            }

            .close-modal {
                top: 10px;
                right: 15px;
                width: 40px;
                height: 40px;
                font-size: 30px;
            }

            .data-label {
                width: 100px;
                font-size: 13px;
            }

            .data-value {
                font-size: 13px;
            }

            .data-input {
                padding: 6px 10px;
                font-size: 13px;
                min-height: 32px;
            }

            .modal-navigation {
                width: 40px;
                height: 40px;
                font-size: 20px;
            }

            .modal-navigation.prev {
                left: 10px;
            }

            .modal-navigation.next {
                right: 10px;
            }

            .modal-controls {
                flex-direction: column;
                gap: 8px;
            }

            .btn-modal {
                padding: 6px 12px;
                font-size: 12px;
            }

            .image-controls {
                top: 5px;
                left: 5px;
                gap: 5px;
            }

            .rotate-btn {
                width: 35px;
                height: 35px;
                font-size: 16px;
            }

            .delete-confirm-overlay {
                font-size: 14px;
                padding: 12px 20px;
            }

            .footer-content {
                font-size: 9px;
                padding: 0 10px;
            }

            .footer-content .phone {
                margin-left: 5px;
                margin-top: 0;
            }

            .footer-content .zalo {
                margin-left: 6px;
                margin-top: 0;
                padding: 1px 4px;
                font-size: 0.8rem;
            }

            .footer-content .donate-button-inline {
                margin-left: 6px;
                margin-top: 0;
                padding: 1px 4px;
                font-size: 0.8rem;
            }
        }
    </style>
</head>

<body>
    <div class="main-content">
        <div class="container">
            <div class="header">
                <div class="header-main">
                    <div class="header-left">
                        <h1>üñºÔ∏è Tr√≠ch xu·∫•t CCCD</h1>
                        <p>X·ª≠ l√Ω h√¨nh ·∫£nh t·ª± ƒë·ªông v·ªõi AI v√† xu·∫•t k·∫øt qu·∫£ CSV</p>
                    </div>

                    <div class="header-center" id="headerStats" style="display: none;">
                        <div class="compact-stat">
                            <div class="compact-stat-number" id="totalImagesHeader">0</div>
                            <div class="compact-stat-label">T·ªïng s·ªë ·∫£nh</div>
                        </div>
                        <div class="compact-stat">
                            <div class="compact-stat-number" id="processedImagesHeader">0</div>
                            <div class="compact-stat-label">ƒê√£ x·ª≠ l√Ω</div>
                        </div>
                        <div class="compact-stat">
                            <div class="compact-stat-number" id="remainingImagesHeader">0</div>
                            <div class="compact-stat-label">C√≤n l·∫°i</div>
                        </div>
                    </div>

                    <div class="header-right">
                        <button class="btn btn-primary" style="padding: 6px 12px; font-size: 12px;"
                            onclick="openApiKeyModal()">‚öôÔ∏è C√†i ƒë·∫∑t API Key</button>
                        <span id="apiStatus" class="api-status disconnected"
                            style="font-size: 11px; padding: 4px 8px;">‚ùå
                            Ch∆∞a c√≥ API Key</span>
                    </div>
                </div>
            </div>

            <!-- API Key Modal -->
            <div id="apiKeyModal" class="modal">
                <div class="modal-content">
                    <span class="close" onclick="closeApiKeyModal()">&times;</span>
                    <h2 class="section-title">‚öôÔ∏è C√†i ƒë·∫∑t OpenAI API Key</h2>
                    <div class="form-group">
                        <label class="form-label" for="apiKey">OpenAI API Key:</label>
                        <input type="password" id="apiKey" class="form-input" placeholder="Nh·∫≠p API Key c·ªßa b·∫°n...">
                        <small style="color: #666; margin-top: 5px; display: block;">
                            API Key s·∫Ω ƒë∆∞·ª£c l∆∞u tr·ªØ c·ª•c b·ªô tr√™n tr√¨nh duy·ªát c·ªßa b·∫°n
                        </small>
                    </div>
                    <div style="margin-top: 20px;">
                        <button class="btn btn-primary" onclick="saveApiKey()">üíæ L∆∞u API Key</button>
                        <button class="btn btn-warning" onclick="clearApiKey()">üóëÔ∏è X√≥a API Key</button>
                    </div>
                    <div id="apiKeyStatus" class="hidden"></div>

                    <!-- Zalo Support Information -->
                    <div
                        style="margin-top: 25px; padding: 15px; background: rgba(0, 104, 255, 0.05); border-radius: 8px; border-left: 3px solid #0068ff;">
                        <p style="margin: 0; font-size: 13px; color: #4a5568; line-height: 1.4;">
                            üí° <strong>C·∫ßn d√πng th·ª≠ ho·∫∑c h·ªó tr·ª£?</strong><br>
                            Li√™n h·ªá Zalo: <a href="https://zalo.me/84926375999" target="_blank"
                                style="color: #0068ff; text-decoration: none; font-weight: 500;">0926.375.999</a>
                        </p>
                    </div>
                </div>
            </div>

            <!-- Images Management -->
            <div id="imagesSection" class="card">
                <h2 class="section-title">üñºÔ∏è Qu·∫£n l√Ω h√¨nh ·∫£nh CCCD</h2>

                <!-- Image Selection and Action Buttons -->
                <div style="margin-bottom: 15px; display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                    <!-- File Selection Input -->
                    <input type="file" id="imageInput" class="file-input" multiple accept="image/*"
                        onchange="handleImageSelection(event)" style="display: none;">
                    <!-- Folder Selection Input -->
                    <input type="file" id="folderInput" class="file-input" webkitdirectory multiple
                        onchange="handleImageSelection(event)" style="display: none;">

                    <!-- Selection Mode Toggle -->
                    <div style="display: flex; gap: 3px; align-items: center;">
                        <label for="imageInput" class="compact-file-input" id="fileSelectBtn">
                            üñºÔ∏è Ch·ªçn h√¨nh ·∫£nh
                        </label>
                        <label for="folderInput" class="compact-file-input folder-btn" id="folderSelectBtn">
                            üìÅ Ch·ªçn th∆∞ m·ª•c
                        </label>
                    </div>
                    <small style="color: #666; font-size: 0.75rem;">H·ªó tr·ª£: JPG, PNG, GIF, WebP</small>

                    <div style="margin-left: auto; display: flex; gap: 5px; flex-wrap: wrap;">
                        <button class="btn btn-success" onclick="processAllImages()" id="processBtn">üöÄ X·ª≠ l√Ω t·∫•t c·∫£
                            ·∫£nh</button>
                        <button class="btn btn-warning" onclick="clearAllImages()" id="clearBtn">üóëÔ∏è X√≥a t·∫•t c·∫£</button>
                        <button class="btn btn-danger" onclick="deleteSelectedItems()" id="deleteSelectedBtn"
                            style="display: none;">üóëÔ∏è X√≥a ƒë√£ ch·ªçn (<span id="selectedCount">0</span>)</button>

                        <!-- Export Buttons -->
                        <div style="position: relative; display: inline-block;">
                            <button class="btn btn-primary" onclick="toggleCSVDropdown()" id="csvDropdownBtn">üìä Xu·∫•t
                                CSV
                                ‚ñº</button>
                            <div id="csvDropdown" class="csv-dropdown" style="display: none;">
                                <button onclick="exportAllToCSV()">üìä Xu·∫•t t·∫•t c·∫£ b·∫£ng</button>
                                <button onclick="exportSuccessToCSV()">‚úÖ Xu·∫•t c√°c item th√†nh c√¥ng</button>
                                <button onclick="exportFailedToCSV()">‚ùå Xu·∫•t c√°c item failed</button>
                            </div>
                        </div>

                        <div style="position: relative; display: inline-block;">
                            <button class="btn btn-success" onclick="toggleExcelDropdown()" id="excelDropdownBtn">üìà
                                Xu·∫•t Excel
                                ‚ñº</button>
                            <div id="excelDropdown" class="csv-dropdown" style="display: none;">
                                <button onclick="exportAllToExcel()">üìä Xu·∫•t t·∫•t c·∫£ b·∫£ng</button>
                                <button onclick="exportSuccessToExcel()">‚úÖ Xu·∫•t c√°c item th√†nh c√¥ng</button>
                                <button onclick="exportFailedToExcel()">‚ùå Xu·∫•t c√°c item failed</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Progress Bar -->
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>

                <!-- Table Controls -->
                <div class="table-controls">
                    <div class="rows-per-page">
                        <label>Hi·ªÉn th·ªã:</label>
                        <select id="rowsPerPage" onchange="updatePagination()">
                            <option value="5" selected>5</option>
                            <option value="10">10</option>
                            <option value="20">20</option>
                            <option value="50">50</option>
                        </select>
                        <span>·∫£nh/trang</span>
                    </div>
                    <div class="pagination-info" id="paginationInfo"></div>
                </div>

                <!-- Images Table -->
                <div style="overflow-x: auto;">
                    <table class="image-table" id="imagesTable">
                        <thead>
                            <tr>
                                <th style="width: 40px;">
                                    <input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll()">
                                </th>
                                <th style="width: 80px;">H√¨nh ·∫£nh</th>
                                <th style="width: 120px;">
                                    Th∆∞ m·ª•c
                                    <button onclick="sortByFolder()"
                                        style="background: none; border: none; cursor: pointer; font-size: 12px; margin-left: 5px;"
                                        title="S·∫Øp x·∫øp theo th∆∞ m·ª•c">üîΩ</button>
                                </th>
                                <th style="width: 70px;">K√≠ch th∆∞·ªõc</th>
                                <th style="width: 80px;">Tr·∫°ng th√°i</th>
                                <th style="width: 100px;">H·ªç t√™n</th>
                                <th style="width: 80px;">NƒÉm sinh</th>
                                <th style="width: 70px;">Gi·ªõi t√≠nh</th>
                                <th style="width: 100px;">CCCD</th>
                                <th style="width: 140px;">Th∆∞·ªùng tr√∫</th>
                                <th style="width: 90px;">Ng√†y h·∫øt h·∫°n</th>
                                <th style="width: 90px;">Thao t√°c</th>
                            </tr>
                        </thead>
                        <tbody id="imagesTableBody">
                        </tbody>
                    </table>
                </div>

                <!-- Pagination -->
                <div class="pagination" id="pagination"></div>
            </div>

            <!-- Image Preview Modal -->
            <div id="imageModal" class="image-modal">
                <span class="close-modal" onclick="closeImageModal()">&times;</span>

                <!-- Delete confirmation overlay -->
                <div id="deleteConfirmOverlay" class="delete-confirm-overlay" style="display: none;">
                    üóëÔ∏è B·∫•m X l·∫ßn n·ªØa ƒë·ªÉ x√≥a
                </div>

                <!-- Navigation buttons -->
                <button class="modal-navigation prev" id="modalPrevBtn" onclick="navigateModal(-1)">‚Äπ</button>
                <button class="modal-navigation next" id="modalNextBtn" onclick="navigateModal(1)">‚Ä∫</button>

                <div class="image-modal-content">
                    <div class="image-modal-left">
                        <!-- Image rotation controls -->
                        <div class="image-controls">
                            <button class="rotate-btn" onclick="rotateImage(-90)" title="Xoay tr√°i 90¬∞">‚Ü∫</button>
                            <button class="rotate-btn" onclick="rotateImage(90)" title="Xoay ph·∫£i 90¬∞">‚Üª</button>
                            <button class="rotate-btn" onclick="resetImageRotation()" title="Reset xoay">‚åÇ</button>
                        </div>
                        <img id="modalImage" class="image-modal-large" src="" alt="">
                    </div>
                    <div class="image-modal-right">
                        <div class="image-modal-title">üìã Th√¥ng tin ƒë√£ tr√≠ch xu·∫•t <span id="modalItemInfo"></span></div>

                        <!-- Extract button -->
                        <div class="modal-actions">
                            <button id="reExtractBtn" class="re-extract-btn" onclick="reExtractCurrentImage()">
                                <span class="btn-icon">üîÑ</span>
                                <span class="btn-text">Tr√≠ch xu·∫•t</span>
                            </button>
                        </div>

                        <div id="modalData">
                            <div class="data-row">
                                <div class="data-label">H·ªç t√™n:</div>
                                <div class="data-value">
                                    <input type="text" id="modalFullNameInput" class="data-input"
                                        onchange="autoSaveModalData()">
                                </div>
                            </div>
                            <div class="data-row">
                                <div class="data-label">S·ªë CCCD:</div>
                                <div class="data-value">
                                    <input type="text" id="modalIdNumberInput" class="data-input"
                                        onchange="autoSaveModalData()">
                                </div>
                            </div>
                            <div class="data-row">
                                <div class="data-label">Ng√†y sinh:</div>
                                <div class="data-value">
                                    <input type="text" id="modalDateOfBirthInput" class="data-input"
                                        placeholder="DD/MM/YYYY" onchange="autoSaveModalData()">
                                </div>
                            </div>
                            <div class="data-row">
                                <div class="data-label">Gi·ªõi t√≠nh:</div>
                                <div class="data-value">
                                    <select id="modalSexInput" class="data-input" onchange="autoSaveModalData()">
                                        <option value="">Ch·ªçn gi·ªõi t√≠nh</option>
                                        <option value="Nam">Nam</option>
                                        <option value="N·ªØ">N·ªØ</option>
                                    </select>
                                </div>
                            </div>
                            <div class="data-row">
                                <div class="data-label">Qu·ªëc t·ªãch:</div>
                                <div class="data-value">
                                    <input type="text" id="modalNationalityInput" class="data-input"
                                        onchange="autoSaveModalData()">
                                </div>
                            </div>
                            <div class="data-row">
                                <div class="data-label">Th∆∞·ªùng tr√∫:</div>
                                <div class="data-value">
                                    <textarea id="modalResidenceInput" class="data-input" rows="2"
                                        onchange="autoSaveModalData()"></textarea>
                                </div>
                            </div>
                            <div class="data-row">
                                <div class="data-label">Ng√†y h·∫øt h·∫°n:</div>
                                <div class="data-value">
                                    <input type="text" id="modalExpiryDateInput" class="data-input"
                                        placeholder="DD/MM/YYYY" onchange="autoSaveModalData()">
                                </div>
                            </div>
                            <div class="data-row">
                                <div class="data-label">Tr·∫°ng th√°i:</div>
                                <div class="data-value" id="modalStatus">-</div>
                            </div>
                            <div class="data-row">
                                <div class="data-label">Th·ªùi gian x·ª≠ l√Ω:</div>
                                <div class="data-value" id="modalProcessedAt">-</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <p>Ph√°t tri·ªÉn b·ªüi <span class="developer-name">Nathan ƒê·ªó</span><a href="tel:0926375999"
                        class="phone">0926.375.999</a><a href="https://zalo.me/84926375999" class="zalo"
                        target="_blank">Zalo</a><button class="donate-button-inline" onclick="openDonateModal()">·ª¶ng
                        h·ªô</button>
                </p>
            </div>
        </div>
    </footer>

    <script defer src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>

    <script defer src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script>
        // Global variables
        let selectedImages = [];
        let currentProcessingIndex = 0;
        let isProcessing = false;

        // Pagination variables
        let currentPage = 1;
        let rowsPerPage = 5;

        // Modal variables
        let currentModalIndex = 0;
        let isEditMode = false;
        let originalData = {};
        let currentRotation = 0;
        let deleteConfirmPending = false;
        let deleteConfirmTimeout = null;

        // IndexedDB variables
        let db = null;
        const DB_NAME = 'CCCDProcessorDB';
        const DB_VERSION = 1;
        const STORE_NAME = 'images';

        // Load saved data on page load
        document.addEventListener('DOMContentLoaded', function () {
            initIndexedDB();
            loadApiKey();
            updateApiStatus();
        });

        // IndexedDB Management
        function initIndexedDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);

                request.onerror = function () {
                    console.error('L·ªói m·ªü IndexedDB:', request.error);
                    showAlert('L·ªói kh·ªüi t·∫°o database. S·∫Ω s·ª≠ d·ª•ng ch·∫ø ƒë·ªô fallback.', 'warning');
                    resolve(false);
                };

                request.onsuccess = function () {
                    db = request.result;
                    console.log('IndexedDB ƒë√£ kh·ªüi t·∫°o th√†nh c√¥ng');
                    loadFromStorage(); // Load data after DB is ready
                    resolve(true);
                };

                request.onupgradeneeded = function () {
                    db = request.result;

                    // Create object store for images
                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        const store = db.createObjectStore(STORE_NAME, { keyPath: 'id' });
                        store.createIndex('name', 'name', { unique: false });
                        store.createIndex('status', 'status', { unique: false });
                        console.log('ƒê√£ t·∫°o object store cho images');
                    }
                };
            });
        }

        function saveImageToIndexedDB(imageInfo) {
            return new Promise((resolve, reject) => {
                if (!db) {
                    resolve(false);
                    return;
                }

                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const store = transaction.objectStore(STORE_NAME);

                // Prepare data to save
                const imageData = {
                    id: imageInfo.id,
                    name: imageInfo.name,
                    folderName: imageInfo.folderName || '',
                    filePath: imageInfo.filePath || '',
                    size: imageInfo.size,
                    status: imageInfo.status,
                    processedAt: imageInfo.processedAt,
                    fullName: imageInfo.fullName || '',
                    dateOfBirth: imageInfo.dateOfBirth || '',
                    idNumber: imageInfo.idNumber || '',
                    placeOfOrigin: imageInfo.placeOfOrigin || '',
                    residence: imageInfo.residence || '',
                    expiryDate: imageInfo.expiryDate || '',
                    sex: imageInfo.sex || '',
                    nationality: imageInfo.nationality || '',
                    fileBlob: imageInfo.file || null, // Save the actual file
                    savedAt: new Date().toISOString()
                };

                const request = store.put(imageData);

                request.onsuccess = function () {
                    resolve(true);
                };

                request.onerror = function () {
                    console.error('L·ªói l∆∞u ·∫£nh v√†o IndexedDB:', request.error);
                    resolve(false);
                };
            });
        }

        function getImageFromIndexedDB(imageId) {
            return new Promise((resolve, reject) => {
                if (!db) {
                    resolve(null);
                    return;
                }

                const transaction = db.transaction([STORE_NAME], 'readonly');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.get(imageId);

                request.onsuccess = function () {
                    resolve(request.result);
                };

                request.onerror = function () {
                    console.error('L·ªói t·∫£i ·∫£nh t·ª´ IndexedDB:', request.error);
                    resolve(null);
                };
            });
        }

        function getAllImagesFromIndexedDB() {
            return new Promise((resolve, reject) => {
                if (!db) {
                    resolve([]);
                    return;
                }

                const transaction = db.transaction([STORE_NAME], 'readonly');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.getAll();

                request.onsuccess = function () {
                    resolve(request.result || []);
                };

                request.onerror = function () {
                    console.error('L·ªói t·∫£i t·∫•t c·∫£ ·∫£nh t·ª´ IndexedDB:', request.error);
                    resolve([]);
                };
            });
        }

        function deleteImageFromIndexedDB(imageId) {
            return new Promise((resolve, reject) => {
                if (!db) {
                    resolve(true);
                    return;
                }

                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.delete(imageId);

                request.onsuccess = function () {
                    resolve(true);
                };

                request.onerror = function () {
                    console.error('L·ªói x√≥a ·∫£nh t·ª´ IndexedDB:', request.error);
                    resolve(false);
                };
            });
        }

        function clearAllImagesFromIndexedDB() {
            return new Promise((resolve, reject) => {
                if (!db) {
                    resolve(true);
                    return;
                }

                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.clear();

                request.onsuccess = function () {
                    resolve(true);
                };

                request.onerror = function () {
                    console.error('L·ªói x√≥a t·∫•t c·∫£ ·∫£nh t·ª´ IndexedDB:', request.error);
                    resolve(false);
                };
            });
        }

        // API Key Management
        function openApiKeyModal() {
            document.getElementById('apiKeyModal').style.display = 'block';
            // Load current API key if exists (masked)
            const savedApiKey = localStorage.getItem('openai_api_key');
            if (savedApiKey) {
                document.getElementById('apiKey').placeholder = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
            }
        }

        function closeApiKeyModal() {
            document.getElementById('apiKeyModal').style.display = 'none';
            document.getElementById('apiKey').value = '';
        }

        // Close modal when clicking outside
        window.onclick = function (event) {
            const modal = document.getElementById('apiKeyModal');
            if (event.target == modal) {
                closeApiKeyModal();
            }
        }

        function saveApiKey() {
            const apiKey = document.getElementById('apiKey').value.trim();
            if (!apiKey) {
                showModalAlert('Vui l√≤ng nh·∫≠p API Key!', 'error');
                return;
            }

            localStorage.setItem('openai_api_key', apiKey);
            showModalAlert('API Key ƒë√£ ƒë∆∞·ª£c l∆∞u th√†nh c√¥ng!', 'success');
            document.getElementById('apiKey').value = '';
            updateApiStatus();

            // Close modal after 1 second
            setTimeout(() => {
                closeApiKeyModal();
            }, 1000);
        }

        function loadApiKey() {
            const savedApiKey = localStorage.getItem('openai_api_key');
            if (savedApiKey) {
                console.log('API Key loaded from localStorage');
            }
        }

        function clearApiKey() {
            if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a API Key?')) {
                localStorage.removeItem('openai_api_key');
                showModalAlert('API Key ƒë√£ ƒë∆∞·ª£c x√≥a!', 'success');
                updateApiStatus();

                // Close modal after 1 second
                setTimeout(() => {
                    closeApiKeyModal();
                }, 1000);
            }
        }

        function updateApiStatus() {
            const apiStatus = document.getElementById('apiStatus');
            const savedApiKey = localStorage.getItem('openai_api_key');

            if (savedApiKey) {
                apiStatus.className = 'api-status connected';
                apiStatus.textContent = '‚úÖ API Key ƒë√£ c√†i ƒë·∫∑t';
            } else {
                apiStatus.className = 'api-status disconnected';
                apiStatus.textContent = '‚ùå Ch∆∞a c√≥ API Key';
            }
        }

        function showModalAlert(message, type) {
            // Remove existing alerts in modal
            const existingAlerts = document.querySelectorAll('#apiKeyModal .alert');
            existingAlerts.forEach(alert => alert.remove());

            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            alert.style.marginTop = '15px';

            // Insert into modal
            const modalContent = document.querySelector('#apiKeyModal .modal-content');
            modalContent.appendChild(alert);

            // Auto remove after 3 seconds
            setTimeout(() => {
                alert.remove();
            }, 3000);
        }

        // Helper function to extract folder name from file path
        function getFolderName(file) {
            if (file.webkitRelativePath) {
                // For folder selection, extract the parent folder name
                const pathParts = file.webkitRelativePath.split('/');
                if (pathParts.length > 1) {
                    // Return the immediate parent folder of the file
                    return pathParts[pathParts.length - 2];
                }
                return pathParts[0]; // Root folder name
            }
            return 'T·ªáp ƒë∆°n l·∫ª'; // For individual file selection
        }

        // Helper function to ensure all items have folder information
        function ensureFolderInfo() {
            let updatedCount = 0;
            selectedImages.forEach(img => {
                if (!img.folderName) {
                    if (img.filePath && img.filePath.includes('/')) {
                        const pathParts = img.filePath.split('/');
                        if (pathParts.length > 1) {
                            img.folderName = pathParts[pathParts.length - 2];
                            updatedCount++;
                        }
                    }
                    if (!img.folderName) {
                        img.folderName = 'T·ªáp ƒë∆°n l·∫ª';
                        updatedCount++;
                    }
                }
            });

            if (updatedCount > 0) {
                displayImagesTable();
                saveToStorage();
                console.log(`ƒê√£ c·∫≠p nh·∫≠t th√¥ng tin th∆∞ m·ª•c cho ${updatedCount} item`);
            }
            return updatedCount;
        }

        // Helper function to check if file is an image
        function isImageFile(file) {
            const imageTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp'];
            return imageTypes.includes(file.type.toLowerCase()) ||
                /\.(jpg|jpeg|png|gif|webp)$/i.test(file.name);
        }

        // Image Selection
        function handleImageSelection(event) {
            const files = Array.from(event.target.files);
            if (files.length === 0) return;

            // Filter only image files
            const imageFiles = files.filter(file => isImageFile(file));

            if (imageFiles.length === 0) {
                showAlert('Kh√¥ng t√¨m th·∫•y t·ªáp h√¨nh ·∫£nh n√†o trong th∆∞ m·ª•c ƒë√£ ch·ªçn', 'warning');
                return;
            }

            // Prevent duplicate images by checking file path and size
            const newImages = [];
            imageFiles.forEach((file) => {
                const fileKey = file.webkitRelativePath || file.name;
                const isDuplicate = selectedImages.some(img =>
                    (img.filePath === fileKey || img.name === file.name) &&
                    img.file && img.file.size === file.size
                );

                if (!isDuplicate) {
                    const folderName = getFolderName(file);
                    newImages.push({
                        id: Date.now() + Math.random(),
                        file: file,
                        name: file.name, // Keep original filename
                        folderName: folderName, // Store folder name separately
                        filePath: fileKey,
                        size: formatFileSize(file.size),
                        status: 'pending',
                        processedAt: null,
                        // CCCD data fields
                        fullName: '',
                        dateOfBirth: '',
                        idNumber: '',
                        residence: '',
                        expiryDate: '',
                        sex: '',
                        nationality: ''
                    });
                }
            });

            selectedImages = [...selectedImages, ...newImages];

            // Auto-sort by folder name alphabetically after adding new images
            selectedImages.sort((a, b) => {
                const folderA = a.folderName || 'T·ªáp ƒë∆°n l·∫ª';
                const folderB = b.folderName || 'T·ªáp ƒë∆°n l·∫ª';
                return folderA.localeCompare(folderB, 'vi');
            });

            if (newImages.length > 0) {
                displayImagesTable();
                updateStats();
                saveToStorage(); // Auto-save when adding new images

                // Show different messages based on selection mode
                const isFolder = event.target.id === 'folderInput';
                if (isFolder) {
                    const uniqueFolders = [...new Set(newImages.map(img => img.folderName))];
                    showAlert(`ƒê√£ qu√©t v√† th√™m ${newImages.length} ·∫£nh t·ª´ ${uniqueFolders.length} th∆∞ m·ª•c`, 'success');
                } else {
                    showAlert(`ƒê√£ th√™m ${newImages.length} ·∫£nh m·ªõi`, 'success');
                }
            } else {
                showAlert('T·∫•t c·∫£ ·∫£nh ƒë√£ c√≥ trong danh s√°ch', 'info');
            }

            // Reset input ƒë·ªÉ c√≥ th·ªÉ ch·ªçn l·∫°i c√πng file
            event.target.value = '';
        }

        // Sorting functionality
        let sortOrder = 'asc'; // 'asc' or 'desc'

        function sortByFolder() {
            // Toggle sort order
            sortOrder = sortOrder === 'asc' ? 'desc' : 'asc';

            // Sort the selectedImages array by folderName
            selectedImages.sort((a, b) => {
                const folderA = a.folderName || 'T·ªáp ƒë∆°n l·∫ª';
                const folderB = b.folderName || 'T·ªáp ƒë∆°n l·∫ª';

                if (sortOrder === 'asc') {
                    return folderA.localeCompare(folderB, 'vi');
                } else {
                    return folderB.localeCompare(folderA, 'vi');
                }
            });

            // Update the sort button icon
            const sortButton = document.querySelector('th button[onclick="sortByFolder()"]');
            if (sortButton) {
                sortButton.textContent = sortOrder === 'asc' ? 'üîº' : 'üîΩ';
                sortButton.title = `S·∫Øp x·∫øp theo th∆∞ m·ª•c (${sortOrder === 'asc' ? 'A-Z' : 'Z-A'})`;
            }

            // Refresh the table display
            displayImagesTable();

            // Show feedback
            showAlert(`ƒê√£ s·∫Øp x·∫øp theo th∆∞ m·ª•c (${sortOrder === 'asc' ? 'A-Z' : 'Z-A'})`, 'info');
        }

        function displayImagesTable() {
            const tbody = document.getElementById('imagesTableBody');
            if (!tbody) {
                console.error('Table body not found!');
                return;
            }
            tbody.innerHTML = '';

            // Calculate pagination
            const totalPages = Math.ceil(selectedImages.length / rowsPerPage);
            const startIndex = (currentPage - 1) * rowsPerPage;
            const endIndex = startIndex + rowsPerPage;
            const currentImages = selectedImages.slice(startIndex, endIndex);

            currentImages.forEach((imageInfo, index) => {
                const globalIndex = startIndex + index;
                const row = document.createElement('tr');

                // Check if file object exists for image preview
                const imagePreview = imageInfo.file
                    ? `<img src="${URL.createObjectURL(imageInfo.file)}" 
                           alt="${imageInfo.name}" 
                           class="image-preview"
                           title="Nh·∫•n ƒë·ªÉ xem chi ti·∫øt"
                           onclick="openImageModal(${globalIndex})">`
                    : `<div class="image-preview" style="background:#f0f0f0; display:flex; align-items:center; justify-content:center; font-size:12px; color:#666; text-align:center; border:1px solid #ddd;" title="·∫¢nh t·ª´ phi√™n tr∆∞·ªõc - c·∫ßn ch·ªçn l·∫°i file">üì∑<br>Kh√¥ng c√≥ ·∫£nh</div>`;

                // For display in table: prioritize folder name, fallback to filename
                let displayName = imageInfo.folderName;
                let tooltipText = '';

                if (displayName && displayName !== 'T·ªáp ƒë∆°n l·∫ª') {
                    // Show folder name in table, with filename in tooltip
                    tooltipText = `Th∆∞ m·ª•c: ${displayName}\nT·ªáp: ${imageInfo.name}`;
                } else {
                    // Fallback: if no folder info, show filename and try to extract folder from filePath
                    if (imageInfo.filePath && imageInfo.filePath.includes('/')) {
                        const pathParts = imageInfo.filePath.split('/');
                        if (pathParts.length > 1) {
                            displayName = pathParts[pathParts.length - 2]; // Parent folder
                            tooltipText = `Th∆∞ m·ª•c: ${displayName}\nT·ªáp: ${imageInfo.name}`;
                        } else {
                            displayName = imageInfo.name;
                            tooltipText = imageInfo.name;
                        }
                    } else {
                        displayName = imageInfo.name;
                        tooltipText = imageInfo.name;
                    }
                }

                row.innerHTML = `
                    <td>
                        <input type="checkbox" class="item-checkbox" data-index="${globalIndex}" onchange="updateSelection()">
                    </td>
                    <td>
                        ${imagePreview}
                    </td>
                    <td title="${tooltipText}">${truncateText(displayName, 20)}</td>
                    <td>${imageInfo.size}</td>
                    <td>
                        <span class="status-badge status-${imageInfo.status}">
                            ${getStatusText(imageInfo.status)}
                        </span>
                    </td>
                    <td>${imageInfo.fullName || ''}</td>
                    <td>${imageInfo.dateOfBirth || ''}</td>
                    <td>${imageInfo.sex || ''}</td>
                    <td>${imageInfo.idNumber || ''}</td>
                    <td title="${imageInfo.residence}">${truncateText(imageInfo.residence, 25)}</td>
                    <td>${imageInfo.expiryDate || ''}</td>
                    <td>
                        <div class="action-menu">
                            <button class="action-btn process" 
                                    onclick="processSingleImage(${globalIndex})"
                                    ${imageInfo.status === 'processing' ? 'disabled' : ''}>
                                ${imageInfo.status === 'processing' ? '‚è≥' : 'üîç'}
                            </button>
                            <button class="action-btn delete" 
                                    onclick="deleteSingleImage(${globalIndex})"
                                    ${imageInfo.status === 'processing' ? 'disabled' : ''}>
                                üóëÔ∏è
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });

            updatePaginationDisplay();
            updatePaginationInfo();
            updateSelection();
        }

        // Image Processing
        async function processAllImages() {
            const apiKey = localStorage.getItem('openai_api_key');
            if (!apiKey) {
                showAlert('‚ö†Ô∏è Vui l√≤ng c√†i ƒë·∫∑t API Key tr∆∞·ªõc khi x·ª≠ l√Ω ·∫£nh!', 'error');
                // Show the API key modal
                openApiKeyModal();
                return;
            }

            if (isProcessing) {
                showAlert('ƒêang x·ª≠ l√Ω, vui l√≤ng ƒë·ª£i...', 'info');
                return;
            }

            isProcessing = true;
            currentProcessingIndex = 0;
            document.getElementById('processBtn').disabled = true;

            showAlert('B·∫Øt ƒë·∫ßu x·ª≠ l√Ω h√¨nh ·∫£nh...', 'info');

            for (let i = 0; i < selectedImages.length; i++) {
                if (selectedImages[i].status === 'completed') continue;

                currentProcessingIndex = i;
                await processImage(i, apiKey);
                updateStats();
                updateProgressBar();
                saveToStorage(); // L∆∞u sau m·ªói ·∫£nh ƒë∆∞·ª£c x·ª≠ l√Ω

                // Delay nh·ªè ƒë·ªÉ tr√°nh rate limit
                await new Promise(resolve => setTimeout(resolve, 1000));
            }

            isProcessing = false;
            document.getElementById('processBtn').disabled = false;
            showAlert('Ho√†n th√†nh x·ª≠ l√Ω t·∫•t c·∫£ h√¨nh ·∫£nh!', 'success');
        }

        async function processImage(index, apiKey) {
            const imageInfo = selectedImages[index];
            imageInfo.status = 'processing';
            displayImagesTable(); // Update table display

            try {
                // Convert image to base64
                const base64Image = await fileToBase64(imageInfo.file);

                // Call OpenAI API
                const result = await callOpenAIAPI(base64Image, apiKey);

                // Parse the result and extract CCCD data
                parseAndSaveCCCDData(imageInfo, result);

                imageInfo.status = 'completed';
                imageInfo.processedAt = new Date().toLocaleString('vi-VN');

            } catch (error) {
                console.error('Error processing image:', error);
                imageInfo.status = 'error';
                imageInfo.processedAt = new Date().toLocaleString('vi-VN');

                // Clear data on error
                imageInfo.fullName = `L·ªói: ${error.message}`;
            }

            displayImagesTable(); // Update table display
        }

        function parseAndSaveCCCDData(imageInfo, result) {
            try {
                // Extract JSON from result text
                let jsonData = null;

                if (typeof result === 'string') {
                    // Try to find JSON in the text
                    const jsonMatch = result.match(/\{[\s\S]*\}/);
                    if (jsonMatch) {
                        jsonData = JSON.parse(jsonMatch[0]);
                    }
                } else if (typeof result === 'object') {
                    jsonData = result;
                }

                if (jsonData) {
                    imageInfo.fullName = jsonData.full_name || '';
                    imageInfo.dateOfBirth = formatDateToDDMMYYYY(jsonData.date_of_birth) || '';
                    imageInfo.idNumber = jsonData.id_number || '';
                    imageInfo.residence = jsonData.residence || '';
                    imageInfo.expiryDate = formatDateToDDMMYYYY(jsonData.expiry_date) || '';
                    imageInfo.sex = formatGender(jsonData.sex) || '';
                    imageInfo.nationality = jsonData.nationality || '';
                } else {
                    imageInfo.fullName = 'Kh√¥ng th·ªÉ ph√¢n t√≠ch d·ªØ li·ªáu';
                    imageInfo.status = 'error';
                }
            } catch (error) {
                console.error('Error parsing CCCD data:', error);
                imageInfo.fullName = 'L·ªói ph√¢n t√≠ch d·ªØ li·ªáu';
                imageInfo.status = 'error';
            }
        }

        // Helper function to format date from YYYY-MM-DD to DD/MM/YYYY
        function formatDateToDDMMYYYY(dateString) {
            if (!dateString) return '';

            // Handle different input formats
            if (dateString.includes('/')) {
                // Already in DD/MM/YYYY format
                return dateString;
            }

            if (dateString.includes('-')) {
                // Convert from YYYY-MM-DD to DD/MM/YYYY
                const parts = dateString.split('-');
                if (parts.length === 3) {
                    return `${parts[2]}/${parts[1]}/${parts[0]}`;
                }
            }

            return dateString; // Return as-is if format is unknown
        }

        // Helper function to format gender
        function formatGender(genderString) {
            if (!genderString) return '';

            const gender = genderString.toLowerCase();
            if (gender === 'male' || gender === 'nam') return 'Nam';
            if (gender === 'female' || gender === 'n·ªØ' || gender === 'nu') return 'N·ªØ';

            return genderString; // Return as-is if not recognized
        }

        // Process single image
        async function processSingleImage(index) {
            const apiKey = localStorage.getItem('openai_api_key');
            if (!apiKey) {
                showAlert('‚ö†Ô∏è Vui l√≤ng c√†i ƒë·∫∑t API Key tr∆∞·ªõc khi x·ª≠ l√Ω ·∫£nh!', 'error');
                openApiKeyModal();
                return;
            }

            if (selectedImages[index].status === 'processing') {
                showAlert('·∫¢nh n√†y ƒëang ƒë∆∞·ª£c x·ª≠ l√Ω...', 'info');
                return;
            }

            await processImage(index, apiKey);
            updateStats();
            saveToStorage();
        }

        // Delete single image
        async function deleteSingleImage(index) {
            if (selectedImages[index].status === 'processing') {
                showAlert('Kh√¥ng th·ªÉ x√≥a ·∫£nh ƒëang x·ª≠ l√Ω', 'error');
                return;
            }

            if (confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a ·∫£nh "${selectedImages[index].name}"?`)) {
                const imageToDelete = selectedImages[index];

                // Delete from IndexedDB
                await deleteImageFromIndexedDB(imageToDelete.id);

                // Remove from array
                selectedImages.splice(index, 1);

                // Adjust current page if needed
                const totalPages = Math.ceil(selectedImages.length / rowsPerPage);
                if (currentPage > totalPages && totalPages > 0) {
                    currentPage = totalPages;
                }

                displayImagesTable();
                updateStats();
                saveToStorage(); // Auto-save when deleting image
            }
        }

        async function callOpenAIAPI(base64Image, apiKey) {
            const imageDataUrl = `data:image/jpeg;base64,${base64Image}`;

            // S·ª≠ d·ª•ng prompt ID ƒë∆∞·ª£c ch·ªâ ƒë·ªãnh trong system message
            const sysText = `
            B·∫°n h√£y th·ª±c hi·ªán b√≥c t√°ch d·ªØ li·ªáu t·ª´ h√¨nh ·∫£nh cƒÉn c∆∞·ªõc c√¥ng d√¢n (CCCD) m·∫∑t tr∆∞·ªõc.
            N·∫øu ·∫£nh ch∆∞a n·∫±m th·∫≥ng th√¨ h√£y x·ª≠ l√Ω ·∫£nh n·∫±m th·∫≥ng r·ªìi m·ªõi b√≥c t√°ch d·ªØ li·ªáu cho ƒë√∫ng.
Y√™u c·∫ßu:

Ch·ªâ l·∫•y d·ªØ li·ªáu hi·ªÉn th·ªã tr√™n m·∫∑t tr∆∞·ªõc c·ªßa th·∫ª CCCD.

N·∫øu ·∫£nh kh√¥ng ph·∫£i m·∫∑t tr∆∞·ªõc (v√≠ d·ª•: m·∫∑t sau ho·∫∑c h√¨nh ·∫£nh kh√°c) ‚Üí tr·∫£ v·ªÅ l·ªói.

D·ªØ li·ªáu ph·∫£i ch√≠nh x√°c tuy·ªát ƒë·ªëi, n·∫øu kh√¥ng tr√≠ch xu·∫•t ƒë·∫ßy ƒë·ªß ho·∫∑c sai ‚Üí tr·∫£ v·ªÅ l·ªói.

Tr·∫£ v·ªÅ k·∫øt qu·∫£ ·ªü ƒë·ªãnh d·∫°ng JSON theo c·∫•u tr√∫c b√™n d∆∞·ªõi.

C√°c y√™u c·∫ßu ƒë·ªãnh d·∫°ng ƒë·∫∑c bi·ªát:

full_name: vi·∫øt HO√ÄN TO√ÄN IN HOA (UPPERCASE, c√≥ d·∫•u).

Ph√¢n bi·ªát r√µ place_of_origin (qu√™ qu√°n) v√† residence (ƒë·ªãa ch·ªâ th∆∞·ªùng tr√∫). Ch·ªâ l·∫•y residence - th√¥ng tin n∆°i th∆∞·ªùng tr√∫

Th√¥ng tin ph·∫£i gi·ªØ nguy√™n d·∫•u ti·∫øng Vi·ªát c√≥ d·∫•u.

Tr∆∞·ªùng h·ª£p h·ª£p l·ªá, JSON m·∫´u nh∆∞ sau:

{
  "country": "VNM",
  "id_number": "046091007791",
  "full_name": "ƒê·ªñ VƒÇN A",
  "date_of_birth": "31/01/1991",
  "sex": "Nam",
  "nationality": "Vi·ªát Nam",
  "residence": "Th√¥n 1, Vinh Thanh, Ph√∫ Vang, Th·ª´a Thi√™n Hu·∫ø",
  "expiry_date": "2031-04-26"
}
  `;

            const body = {
                model: "gpt-4.1",
                input: [
                    {
                        role: "system",
                        content: [{ type: "input_text", text: sysText }]
                    },
                    {
                        role: "user",
                        content: [{ type: "input_image", image_url: imageDataUrl }]
                    }
                ],
                tools: [],
                text: { format: { type: "text" } },
                temperature: 2,
                top_p: 1,
                stream: false,
                max_output_tokens: 32768,
                store: true,
                reasoning: {}
            };

            const response = await fetch('https://api.openai.com/v1/responses', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${apiKey}`,
                    'Content-Type': 'application/json',
                    'OpenAI-Beta': 'responses=v1'
                },
                body: JSON.stringify(body)
            });

            if (!response.ok) {
                const errorText = await response.text();
                let errorMessage = `HTTP ${response.status}`;
                try {
                    const errorData = JSON.parse(errorText);
                    errorMessage = errorData.error?.message || errorMessage;
                } catch (e) {
                    errorMessage = errorText || errorMessage;
                }
                throw new Error(errorMessage);
            }

            const data = await response.json();

            // Tr√≠ch xu·∫•t text t·ª´ response theo format m·ªõi
            if (data.output && Array.isArray(data.output) && data.output.length > 0) {
                const message = data.output[0];
                if (message.content && Array.isArray(message.content)) {
                    return message.content
                        .filter(item => item.type === 'output_text')
                        .map(item => item.text)
                        .join('');
                }
            }

            // Fallback cho c√°c format kh√°c
            return data.content || data.response || data.output || 'Kh√¥ng c√≥ k·∫øt qu·∫£ t·ª´ API';
        }

        // Utility Functions
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => {
                    const base64 = reader.result.split(',')[1];
                    resolve(base64);
                };
                reader.onerror = error => reject(error);
            });
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function getStatusText(status) {
            const statusMap = {
                'pending': 'Ch·ªù',
                'processing': 'ƒêang',
                'completed': 'Xong',
                'error': 'L·ªói'
            };
            return statusMap[status] || status;
        }

        function truncateText(text, maxLength) {
            if (!text) return '';
            return text.length > maxLength ? text.substring(0, maxLength) + '...' : text;
        }

        // Checkbox Selection Functions
        function updateSelection() {
            const checkboxes = document.querySelectorAll('.item-checkbox');
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');
            const deleteSelectedBtn = document.getElementById('deleteSelectedBtn');
            const selectedCount = document.getElementById('selectedCount');

            let selectedItems = 0;
            let totalCheckboxes = checkboxes.length;

            checkboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    selectedItems++;
                }
            });

            // Update select all checkbox state
            if (selectedItems === 0) {
                selectAllCheckbox.indeterminate = false;
                selectAllCheckbox.checked = false;
            } else if (selectedItems === totalCheckboxes) {
                selectAllCheckbox.indeterminate = false;
                selectAllCheckbox.checked = true;
            } else {
                selectAllCheckbox.indeterminate = true;
                selectAllCheckbox.checked = false;
            }

            // Update delete button visibility and count
            if (selectedItems > 0) {
                deleteSelectedBtn.style.display = 'inline-block';
                selectedCount.textContent = selectedItems;
            } else {
                deleteSelectedBtn.style.display = 'none';
            }
        }

        function toggleSelectAll() {
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');
            const checkboxes = document.querySelectorAll('.item-checkbox');

            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAllCheckbox.checked;
            });

            updateSelection();
        }

        async function deleteSelectedItems() {
            const checkboxes = document.querySelectorAll('.item-checkbox:checked');
            const selectedIndices = Array.from(checkboxes).map(checkbox => parseInt(checkbox.dataset.index));

            if (selectedIndices.length === 0) {
                alert('Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt item ƒë·ªÉ x√≥a!');
                return;
            }

            const confirmMessage = `B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a ${selectedIndices.length} item ƒë√£ ch·ªçn?`;
            if (!confirm(confirmMessage)) {
                return;
            }

            // Check if any selected items are being processed
            for (let index of selectedIndices) {
                if (selectedImages[index] && selectedImages[index].status === 'processing') {
                    alert('Kh√¥ng th·ªÉ x√≥a item ƒëang ƒë∆∞·ª£c x·ª≠ l√Ω!');
                    return;
                }
            }

            // Sort indices in descending order to avoid index shifting issues
            selectedIndices.sort((a, b) => b - a);

            // Delete items from both IndexedDB and array
            for (let index of selectedIndices) {
                const imageToDelete = selectedImages[index];
                if (imageToDelete) {
                    // Delete from IndexedDB
                    await deleteImageFromIndexedDB(imageToDelete.id);
                    // Remove from array
                    selectedImages.splice(index, 1);
                }
            }

            // Clear all selections
            const allCheckboxes = document.querySelectorAll('.item-checkbox');
            allCheckboxes.forEach(checkbox => {
                checkbox.checked = false;
            });

            // Update display
            updateSelection();
            displayImagesTable();
            updateStats();
            saveToStorage();

            showAlert(`ƒê√£ x√≥a ${selectedIndices.length} item th√†nh c√¥ng!`, 'success');
        }

        // Pagination Functions
        function updatePaginationDisplay() {
            const totalPages = Math.ceil(selectedImages.length / rowsPerPage);
            const pagination = document.getElementById('pagination');
            pagination.innerHTML = '';

            if (totalPages <= 1) return;

            // Previous button
            const prevBtn = document.createElement('button');
            prevBtn.textContent = '¬´ Tr∆∞·ªõc';
            prevBtn.disabled = currentPage === 1;
            prevBtn.onclick = () => {
                currentPage--;
                displayImagesTable();
            };
            pagination.appendChild(prevBtn);

            // Page numbers
            const startPage = Math.max(1, currentPage - 2);
            const endPage = Math.min(totalPages, currentPage + 2);

            if (startPage > 1) {
                const firstBtn = document.createElement('button');
                firstBtn.textContent = '1';
                firstBtn.onclick = () => {
                    currentPage = 1;
                    displayImagesTable();
                };
                pagination.appendChild(firstBtn);

                if (startPage > 2) {
                    const dots = document.createElement('span');
                    dots.textContent = '...';
                    pagination.appendChild(dots);
                }
            }

            for (let i = startPage; i <= endPage; i++) {
                const pageBtn = document.createElement('button');
                pageBtn.textContent = i;
                pageBtn.className = i === currentPage ? 'active' : '';
                pageBtn.onclick = () => {
                    currentPage = i;
                    displayImagesTable();
                };
                pagination.appendChild(pageBtn);
            }

            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    const dots = document.createElement('span');
                    dots.textContent = '...';
                    pagination.appendChild(dots);
                }

                const lastBtn = document.createElement('button');
                lastBtn.textContent = totalPages;
                lastBtn.onclick = () => {
                    currentPage = totalPages;
                    displayImagesTable();
                };
                pagination.appendChild(lastBtn);
            }

            // Next button
            const nextBtn = document.createElement('button');
            nextBtn.textContent = 'Sau ¬ª';
            nextBtn.disabled = currentPage === totalPages;
            nextBtn.onclick = () => {
                currentPage++;
                displayImagesTable();
            };
            pagination.appendChild(nextBtn);
        }

        function updatePaginationInfo() {
            const totalImages = selectedImages.length;
            const startIndex = (currentPage - 1) * rowsPerPage + 1;
            const endIndex = Math.min(currentPage * rowsPerPage, totalImages);

            const info = document.getElementById('paginationInfo');
            if (totalImages > 0) {
                info.textContent = `Hi·ªÉn th·ªã ${startIndex}-${endIndex} c·ªßa ${totalImages} ·∫£nh`;
            } else {
                info.textContent = '';
            }
        }

        function updatePaginationFromSelect() {
            rowsPerPage = parseInt(document.getElementById('rowsPerPage').value);
            currentPage = 1; // Reset to first page
            displayImagesTable();
        }

        // Rename the global function to avoid conflict
        window.updatePagination = updatePaginationFromSelect;

        // Auto-save when pagination changes
        function updatePaginationFromSelectWithSave() {
            updatePaginationFromSelect();
            saveToStorage();
        }

        // Update the global function to include auto-save
        window.updatePagination = updatePaginationFromSelectWithSave;

        function updateStats() {
            const total = selectedImages.length;
            const processed = selectedImages.filter(img => img.status === 'completed').length;
            const remaining = total - processed;

            // Update header stats (new compact stats)
            document.getElementById('totalImagesHeader').textContent = total;
            document.getElementById('processedImagesHeader').textContent = processed;
            document.getElementById('remainingImagesHeader').textContent = remaining;

            // Show/hide header stats based on whether there are images
            const headerStats = document.getElementById('headerStats');
            if (total > 0) {
                headerStats.style.display = 'flex';
            } else {
                headerStats.style.display = 'none';
            }
        }

        function updateProgressBar() {
            const total = selectedImages.length;
            const processed = selectedImages.filter(img => img.status === 'completed').length;
            const percentage = total > 0 ? (processed / total) * 100 : 0;

            document.getElementById('progressFill').style.width = percentage + '%';
        }

        function showSection(sectionId) {
            const element = document.getElementById(sectionId);
            if (!element) {
                console.error('Section not found:', sectionId);
                return;
            }
            element.classList.remove('hidden');
        }

        function hideSection(sectionId) {
            document.getElementById(sectionId).classList.add('hidden');
        }

        function showAlert(message, type) {
            // Remove existing alerts
            const existingAlerts = document.querySelectorAll('.alert');
            existingAlerts.forEach(alert => alert.remove());

            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;

            // Insert after header
            const header = document.querySelector('.header');
            header.parentNode.insertBefore(alert, header.nextSibling);

            // Auto remove after 5 seconds
            setTimeout(() => {
                alert.remove();
            }, 5000);
        }

        // Image Modal Functions
        function openImageModal(imageIndex) {
            currentModalIndex = imageIndex;
            displayModalContent();

            // Show modal
            document.getElementById('imageModal').style.display = 'block';
            document.body.style.overflow = 'hidden'; // Prevent background scrolling
        }

        function displayModalContent() {
            const imageInfo = selectedImages[currentModalIndex];
            if (!imageInfo) return;

            // Check if file object exists
            if (!imageInfo.file) {
                showAlert('Kh√¥ng th·ªÉ hi·ªÉn th·ªã ·∫£nh - d·ªØ li·ªáu t·ª´ phi√™n tr∆∞·ªõc. Vui l√≤ng ch·ªçn l·∫°i file ·∫£nh.', 'error');
                return;
            }

            // Set image
            const modalImage = document.getElementById('modalImage');
            modalImage.src = URL.createObjectURL(imageInfo.file);
            modalImage.alt = imageInfo.name;

            // Update item info
            document.getElementById('modalItemInfo').textContent = `(${currentModalIndex + 1}/${selectedImages.length})`;

            // Set data in input fields
            document.getElementById('modalFullNameInput').value = imageInfo.fullName || '';
            document.getElementById('modalIdNumberInput').value = imageInfo.idNumber || '';
            document.getElementById('modalDateOfBirthInput').value = imageInfo.dateOfBirth || '';
            document.getElementById('modalSexInput').value = imageInfo.sex || '';
            document.getElementById('modalNationalityInput').value = imageInfo.nationality || '';
            document.getElementById('modalResidenceInput').value = imageInfo.residence || '';
            document.getElementById('modalExpiryDateInput').value = imageInfo.expiryDate || '';

            // Set read-only fields
            document.getElementById('modalStatus').textContent = getStatusText(imageInfo.status);
            document.getElementById('modalProcessedAt').textContent = imageInfo.processedAt || '-';

            // Update navigation buttons
            updateModalNavigation();

            // Reset image rotation when switching images
            resetImageRotation();

            // Reset delete confirmation when switching images
            hideDeleteConfirm();

            // Update extract button text based on status
            updateExtractButtonText();
        }

        // Update extract button text based on image status
        function updateExtractButtonText() {
            const imageInfo = selectedImages[currentModalIndex];
            if (!imageInfo) return;

            const btnText = document.querySelector('#reExtractBtn .btn-text');
            const btnIcon = document.querySelector('#reExtractBtn .btn-icon');

            if (!btnText || !btnIcon) return;

            // Check if image has been processed before
            const hasBeenProcessed = imageInfo.status === 'completed' ||
                imageInfo.status === 'error' ||
                imageInfo.processedAt;

            if (hasBeenProcessed) {
                btnText.textContent = 'Tr√≠ch xu·∫•t l·∫°i';
                btnIcon.textContent = 'üîÑ';
            } else {
                btnText.textContent = 'Tr√≠ch xu·∫•t';
                btnIcon.textContent = 'üîç';
            }
        }

        function updateModalNavigation() {
            const prevBtn = document.getElementById('modalPrevBtn');
            const nextBtn = document.getElementById('modalNextBtn');

            prevBtn.disabled = currentModalIndex === 0;
            nextBtn.disabled = currentModalIndex === selectedImages.length - 1;
        }

        function navigateModal(direction) {
            const newIndex = currentModalIndex + direction;
            if (newIndex >= 0 && newIndex < selectedImages.length) {
                currentModalIndex = newIndex;
                displayModalContent();
            }
        }

        function closeImageModal() {
            document.getElementById('imageModal').style.display = 'none';
            document.body.style.overflow = 'auto'; // Restore scrolling
        }

        // Re-extract current image function
        async function reExtractCurrentImage() {
            const imageInfo = selectedImages[currentModalIndex];
            if (!imageInfo) return;

            const reExtractBtn = document.getElementById('reExtractBtn');
            const btnIcon = reExtractBtn.querySelector('.btn-icon');
            const btnText = reExtractBtn.querySelector('.btn-text');

            // Check if API key exists
            const apiKey = localStorage.getItem('openai_api_key');
            if (!apiKey) {
                showAlert('Vui l√≤ng nh·∫≠p API Key tr∆∞·ªõc khi tr√≠ch xu·∫•t', 'error');
                return;
            }

            // Disable button and show loading state
            reExtractBtn.disabled = true;
            btnText.textContent = 'ƒêang tr√≠ch xu·∫•t...';
            btnIcon.textContent = '‚è≥';

            try {
                // Update status to processing
                imageInfo.status = 'processing';
                imageInfo.processedAt = new Date().toLocaleString('vi-VN');

                // Update modal display
                displayModalContent();
                displayImagesTable();

                // Process the image
                await processImage(currentModalIndex, apiKey);

                // Show success message
                showAlert('Tr√≠ch xu·∫•t l·∫°i th√†nh c√¥ng!', 'success');

            } catch (error) {
                console.error('Error re-extracting image:', error);
                showAlert(`L·ªói khi tr√≠ch xu·∫•t l·∫°i: ${error.message}`, 'error');
            } finally {
                // Re-enable button
                reExtractBtn.disabled = false;

                // Update modal display (this will also update button text)
                displayModalContent();
                displayImagesTable();
                updateStats();
                saveToStorage();
            }
        }

        // Auto Save Function
        function autoSaveModalData() {
            const imageInfo = selectedImages[currentModalIndex];
            if (!imageInfo) return;

            // Get values from input fields
            const newData = {
                fullName: document.getElementById('modalFullNameInput').value.trim(),
                idNumber: document.getElementById('modalIdNumberInput').value.trim(),
                dateOfBirth: document.getElementById('modalDateOfBirthInput').value.trim(),
                sex: document.getElementById('modalSexInput').value,
                nationality: document.getElementById('modalNationalityInput').value.trim(),
                residence: document.getElementById('modalResidenceInput').value.trim(),
                expiryDate: document.getElementById('modalExpiryDateInput').value.trim()
            };

            // Update the image info
            imageInfo.fullName = newData.fullName;
            imageInfo.idNumber = newData.idNumber;
            imageInfo.dateOfBirth = newData.dateOfBirth;
            imageInfo.sex = newData.sex;
            imageInfo.nationality = newData.nationality;
            imageInfo.residence = newData.residence;
            imageInfo.expiryDate = newData.expiryDate;

            // Update table display
            displayImagesTable();

            // Auto save to storage
            saveToStorage();

            console.log('ƒê√£ t·ª± ƒë·ªông l∆∞u thay ƒë·ªïi');
        }

        // Image rotation functions
        function rotateImage(degrees) {
            currentRotation += degrees;
            // Normalize rotation to 0-360 range
            currentRotation = ((currentRotation % 360) + 360) % 360;

            const modalImage = document.getElementById('modalImage');
            modalImage.style.transform = `rotate(${currentRotation}deg)`;
        }

        function resetImageRotation() {
            currentRotation = 0;
            const modalImage = document.getElementById('modalImage');
            modalImage.style.transform = 'rotate(0deg)';
        }

        // Delete confirmation functions
        function showDeleteConfirm() {
            deleteConfirmPending = true;
            const overlay = document.getElementById('deleteConfirmOverlay');
            overlay.style.display = 'block';

            // Auto-hide after 3 seconds
            deleteConfirmTimeout = setTimeout(() => {
                hideDeleteConfirm();
            }, 3000);
        }

        function hideDeleteConfirm() {
            deleteConfirmPending = false;
            const overlay = document.getElementById('deleteConfirmOverlay');
            overlay.style.display = 'none';

            if (deleteConfirmTimeout) {
                clearTimeout(deleteConfirmTimeout);
                deleteConfirmTimeout = null;
            }
        }

        async function deleteCurrentItem() {
            const imageToDelete = selectedImages[currentModalIndex];

            if (!imageToDelete) return;

            // Delete from IndexedDB
            await deleteImageFromIndexedDB(imageToDelete.id);

            // Remove from array
            selectedImages.splice(currentModalIndex, 1);

            // Adjust current index if needed
            if (currentModalIndex >= selectedImages.length && selectedImages.length > 0) {
                currentModalIndex = selectedImages.length - 1;
            }

            // Hide delete confirmation
            hideDeleteConfirm();

            // If no more images, close modal
            if (selectedImages.length === 0) {
                closeImageModal();
                showAlert('ƒê√£ x√≥a ·∫£nh cu·ªëi c√πng', 'success');
            } else {
                // Show next/previous image
                displayModalContent();
                showAlert('ƒê√£ x√≥a ·∫£nh th√†nh c√¥ng', 'success');
            }

            // Update table and stats
            displayImagesTable();
            updateStats();
            saveToStorage();
        }

        // Close modal when clicking outside the content
        document.addEventListener('click', function (event) {
            const modal = document.getElementById('imageModal');
            if (event.target === modal) {
                closeImageModal();
            }
        });

        // Handle keyboard shortcuts in modal
        document.addEventListener('keydown', function (event) {
            const modal = document.getElementById('imageModal');
            const isModalOpen = modal.style.display === 'block';

            if (!isModalOpen) return;

            // Don't handle shortcuts if user is typing in an input (except Escape)
            if (event.target.tagName === 'INPUT' || event.target.tagName === 'TEXTAREA' || event.target.tagName === 'SELECT') {
                if (event.key === 'Escape') {
                    event.preventDefault();
                    closeImageModal();
                }
                return;
            }

            switch (event.key) {
                case 'Escape':
                    event.preventDefault();
                    closeImageModal();
                    break;
                case 'ArrowLeft':
                    event.preventDefault();
                    if (currentModalIndex > 0) {
                        navigateModal(-1);
                    }
                    break;
                case 'ArrowRight':
                    event.preventDefault();
                    if (currentModalIndex < selectedImages.length - 1) {
                        navigateModal(1);
                    }
                    break;
                case 'ArrowUp':
                    event.preventDefault();
                    rotateImage(-90); // Xoay tr√°i khi b·∫•m l√™n
                    break;
                case 'ArrowDown':
                    event.preventDefault();
                    rotateImage(90); // Xoay ph·∫£i khi b·∫•m xu·ªëng
                    break;
                case 'r':
                case 'R':
                    event.preventDefault();
                    rotateImage(90);
                    break;
                case 'l':
                case 'L':
                    event.preventDefault();
                    rotateImage(-90);
                    break;
                case '0':
                    event.preventDefault();
                    resetImageRotation();
                    break;
                case 'x':
                case 'X':
                    event.preventDefault();
                    if (deleteConfirmPending) {
                        // Second X press - delete the item
                        deleteCurrentItem();
                    } else {
                        // First X press - show confirmation
                        showDeleteConfirm();
                    }
                    break;
            }
        });


        // Combined Storage Management (localStorage + IndexedDB)
        async function loadFromStorage() {
            try {
                // Load basic data from localStorage first
                let savedData = localStorage.getItem('cccd_processing_data');

                // Fallback to old key for backward compatibility
                if (!savedData) {
                    savedData = localStorage.getItem('image_processing_results');
                }

                let localStorageImages = [];
                if (savedData) {
                    const data = JSON.parse(savedData);
                    if (data.selectedImages && data.selectedImages.length > 0) {
                        localStorageImages = data.selectedImages;

                        // Restore pagination settings
                        if (data.currentPage) currentPage = data.currentPage;
                        if (data.rowsPerPage) {
                            rowsPerPage = data.rowsPerPage;
                            document.getElementById('rowsPerPage').value = rowsPerPage;
                        }
                    }
                }

                // Load images from IndexedDB
                const indexedDBImages = await getAllImagesFromIndexedDB();

                // Merge data: IndexedDB takes priority for file objects
                const mergedImages = [];
                const indexedDBMap = new Map();

                // Create map of IndexedDB images by ID
                indexedDBImages.forEach(img => {
                    indexedDBMap.set(img.id, img);
                });

                // Process localStorage images and merge with IndexedDB
                localStorageImages.forEach(localImg => {
                    const indexedImg = indexedDBMap.get(localImg.id);

                    if (indexedImg) {
                        // Use IndexedDB data (has file object)
                        mergedImages.push({
                            ...indexedImg,
                            file: indexedImg.fileBlob // Restore file object
                        });
                        indexedDBMap.delete(localImg.id); // Remove from map
                    } else {
                        // Use localStorage data (no file object)
                        mergedImages.push({
                            ...localImg,
                            file: null
                        });
                    }
                });

                // Add remaining IndexedDB images that weren't in localStorage
                indexedDBMap.forEach(img => {
                    mergedImages.push({
                        ...img,
                        file: img.fileBlob
                    });
                });

                // Update selectedImages
                selectedImages = mergedImages;

                // Add folderName for old items that don't have it
                selectedImages.forEach(img => {
                    if (!img.folderName && img.filePath && img.filePath.includes('/')) {
                        const pathParts = img.filePath.split('/');
                        if (pathParts.length > 1) {
                            img.folderName = pathParts[pathParts.length - 2]; // Parent folder
                        }
                    }
                    // Set default if still no folderName
                    if (!img.folderName) {
                        img.folderName = 'T·ªáp ƒë∆°n l·∫ª';
                    }
                });

                // Auto-sort by folder name alphabetically after loading
                selectedImages.sort((a, b) => {
                    const folderA = a.folderName || 'T·ªáp ƒë∆°n l·∫ª';
                    const folderB = b.folderName || 'T·ªáp ƒë∆°n l·∫ª';
                    return folderA.localeCompare(folderB, 'vi');
                });

                // Display the restored data
                if (selectedImages.length > 0) {
                    displayImagesTable();
                    updateStats();
                    updateProgressBar();
                    showSection('imagesSection');

                    const completedCount = selectedImages.filter(img => img.status === 'completed').length;
                    const pendingCount = selectedImages.filter(img => img.status === 'pending').length;
                    const withFileCount = selectedImages.filter(img => img.file !== null).length;

                    showAlert(`ƒê√£ kh√¥i ph·ª•c ${selectedImages.length} ·∫£nh: ${completedCount} ƒë√£ x·ª≠ l√Ω, ${pendingCount} ch∆∞a x·ª≠ l√Ω, ${withFileCount} c√≥ file ·∫£nh`, 'success');
                }

            } catch (error) {
                console.error('Error loading from storage:', error);
                showAlert('L·ªói khi t·∫£i d·ªØ li·ªáu t·ª´ b·ªô nh·ªõ', 'error');
            }
        }

        async function saveToStorage() {
            try {
                // Save to localStorage (without file objects)
                const localStorageData = {
                    selectedImages: selectedImages.map(img => ({
                        id: img.id,
                        name: img.name,
                        folderName: img.folderName || '',
                        filePath: img.filePath || '',
                        size: img.size,
                        status: img.status,
                        processedAt: img.processedAt,
                        fullName: img.fullName || '',
                        dateOfBirth: img.dateOfBirth || '',
                        idNumber: img.idNumber || '',
                        residence: img.residence || '',
                        expiryDate: img.expiryDate || '',
                        sex: img.sex || '',
                        nationality: img.nationality || ''
                    })),
                    currentPage: currentPage,
                    rowsPerPage: rowsPerPage,
                    lastSaved: new Date().toISOString()
                };
                localStorage.setItem('cccd_processing_data', JSON.stringify(localStorageData));

                // Save to IndexedDB (with file objects) - in background
                selectedImages.forEach(async (img) => {
                    if (img.file) {
                        await saveImageToIndexedDB(img);
                    }
                });

                console.log('Data saved to both localStorage and IndexedDB');
            } catch (error) {
                console.error('Error saving to storage:', error);
                showAlert('L·ªói khi l∆∞u d·ªØ li·ªáu', 'error');
            }
        }

        // Legacy function for backward compatibility
        function saveToLocalStorage() {
            try {
                const data = {
                    selectedImages: selectedImages.map(img => ({
                        id: img.id,
                        name: img.name,
                        folderName: img.folderName || '',
                        filePath: img.filePath || '',
                        size: img.size,
                        status: img.status,
                        processedAt: img.processedAt,
                        fullName: img.fullName || '',
                        dateOfBirth: img.dateOfBirth || '',
                        idNumber: img.idNumber || '',
                        residence: img.residence || '',
                        expiryDate: img.expiryDate || '',
                        sex: img.sex || '',
                        nationality: img.nationality || '',
                        // Save file as base64 for completed images only to save space
                        fileData: img.status === 'completed' && img.file ? null : null
                    })),
                    currentPage: currentPage,
                    rowsPerPage: rowsPerPage,
                    lastSaved: new Date().toISOString()
                };
                localStorage.setItem('cccd_processing_data', JSON.stringify(data));
                console.log('Data saved to localStorage successfully');
            } catch (error) {
                console.error('Error saving to localStorage:', error);
                showAlert('L·ªói khi l∆∞u d·ªØ li·ªáu v√†o b·ªô nh·ªõ t·∫°m', 'error');
            }
        }

        function loadFromLocalStorage() {
            try {
                // Try new storage key first
                let savedData = localStorage.getItem('cccd_processing_data');

                // Fallback to old key for backward compatibility
                if (!savedData) {
                    savedData = localStorage.getItem('image_processing_results');
                }

                if (savedData) {
                    const data = JSON.parse(savedData);

                    if (data.selectedImages && data.selectedImages.length > 0) {
                        // Restore processed images data (without file objects)
                        selectedImages = data.selectedImages.map(img => ({
                            ...img,
                            file: null // File objects cannot be restored from localStorage
                        }));

                        // Restore pagination settings
                        if (data.currentPage) currentPage = data.currentPage;
                        if (data.rowsPerPage) {
                            rowsPerPage = data.rowsPerPage;
                            document.getElementById('rowsPerPage').value = rowsPerPage;
                        }

                        // Display the restored data
                        if (selectedImages.length > 0) {
                            displayImagesTable();
                            updateStats();
                            updateProgressBar();
                            showSection('imagesSection');

                            const completedCount = selectedImages.filter(img => img.status === 'completed').length;
                            const pendingCount = selectedImages.filter(img => img.status === 'pending').length;

                            showAlert(`ƒê√£ kh√¥i ph·ª•c ${selectedImages.length} ·∫£nh t·ª´ phi√™n tr∆∞·ªõc: ${completedCount} ƒë√£ x·ª≠ l√Ω, ${pendingCount} ch∆∞a x·ª≠ l√Ω`, 'success');
                        }
                    }
                }
            } catch (error) {
                console.error('Error loading from localStorage:', error);
                showAlert('L·ªói khi t·∫£i d·ªØ li·ªáu t·ª´ b·ªô nh·ªõ t·∫°m', 'error');
            }
        }

        async function clearAllImages() {
            if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a t·∫•t c·∫£ h√¨nh ·∫£nh v√† k·∫øt qu·∫£?')) {
                selectedImages = [];

                // Clear localStorage
                localStorage.removeItem('image_processing_results');
                localStorage.removeItem('cccd_processing_data');

                // Clear IndexedDB
                await clearAllImagesFromIndexedDB();

                document.getElementById('imagesTableBody').innerHTML = '';
                hideSection('imagesSection');

                updateStats();
                updateProgressBar();

                showAlert('ƒê√£ x√≥a t·∫•t c·∫£ h√¨nh ·∫£nh!', 'success');
            }
        }

        // Helper function to split Vietnamese full name
        function splitVietnameseName(fullName) {
            if (!fullName || fullName.trim() === '') {
                return { ho: '', tenDem: '', ten: '' };
            }

            const nameParts = fullName.trim().split(/\s+/);

            if (nameParts.length === 1) {
                // Only one word - treat as given name
                return { ho: '', tenDem: '', ten: nameParts[0] };
            } else if (nameParts.length === 2) {
                // Two words - surname and given name, no middle name
                return { ho: nameParts[0], tenDem: '', ten: nameParts[1] };
            } else {
                // Three or more words - first is surname, last is given name, middle part(s) are middle name
                const ho = nameParts[0];
                const ten = nameParts[nameParts.length - 1];
                const tenDem = nameParts.slice(1, -1).join(' ');
                return { ho, tenDem, ten };
            }
        }

        // Postal code lookup table for Vietnamese provinces
        const POSTAL_CODES = {
            'An Giang': '880000',
            'B·∫°c Li√™u': '260000',
            'B·∫Øc C·∫°n': '960000',
            'B·∫Øc Giang': '220000',
            'B·∫Øc Ninh': '790000',
            'B·∫øn Tre': '930000',
            'B√¨nh D∆∞∆°ng': '590000',
            'B√¨nh ƒê·ªãnh': '820000',
            'B√¨nh Ph∆∞·ªõc': '830000',
            'B√¨nh Thu·∫≠n': '800000',
            'C√† Mau': '970000',
            'Cao B·∫±ng': '270000',
            'C·∫ßn Th∆°': '900000',
            'ƒê√† N·∫µng': '550000',
            'ƒêi·ªán Bi√™n': '380000',
            'ƒê·∫Øk L·∫Øk': '630000',
            'ƒê·∫Øk N√¥ng': '640000',
            'ƒê·ªìng Nai': '810000',
            'ƒê·ªìng Th√°p': '870000',
            'Gia Lai': '600000',
            'H√† Giang': '310000',
            'H√† Nam': '400000',
            'H√† Tƒ©nh': '480000',
            'H√† N·ªôi': '100000',
            'H·∫£i D∆∞∆°ng': '170000',
            'H·∫£i Ph√≤ng': '180000',
            'H·∫≠u Giang': '910000',
            'Ho√† B√¨nh': '350000',
            'Tp. H·ªì Ch√≠ Minh': '700000',
            'H·ªì Ch√≠ Minh': '700000', // Alternative name
            'TP HCM': '700000', // Alternative name
            'TPHCM': '700000', // Alternative name
            'H∆∞ng Y√™n': '160000',
            'Kh√°nh Ho√†': '650000',
            'Kh√°nh H√≤a': '650000', // Alternative spelling
            'Ki√™n Giang': '920000',
            'Kon Tum': '580000',
            'Lai Ch√¢u': '390000',
            'L·∫°ng S∆°n': '240000',
            'L√†o Cai': '330000',
            'L√¢m ƒê·ªìng': '670000',
            'Long An': '850000',
            'Nam ƒê·ªãnh': '420000',
            'Ngh·ªá An': '460000',
            'Ninh B√¨nh': '430000',
            'Ninh Thu·∫≠n': '660000',
            'Ph√∫ Th·ªç': '290000',
            'Ph√∫ Y√™n': '620000',
            'Qu·∫£ng B√¨nh': '510000',
            'Qu·∫£ng Nam': '560000',
            'Qu·∫£ng Ng√£i': '570000',
            'Qu·∫£ng Ninh': '200000',
            'Qu·∫£ng Tr·ªã': '520000',
            'S√≥c TrƒÉng': '950000',
            'S∆°n La': '360000',
            'T√¢y Ninh': '840000',
            'Th√°i B√¨nh': '410000',
            'Th√°i Nguy√™n': '250000',
            'Thanh Ho√°': '440000',
            'Thanh H√≥a': '440000', // Alternative spelling
            'Th·ª´a Thi√™n Hu·∫ø': '530000',
            'Hu·∫ø': '530000', // Alternative name
            'Ti·ªÅn Giang': '860000',
            'Tr√† Vinh': '940000',
            'Tuy√™n Quang': '300000',
            'Vƒ©nh Long': '890000',
            'Vƒ©nh Ph√∫c': '280000',
            'Y√™n B√°i': '320000',
            'B√† R·ªãa V≈©ng T√†u': '790000',
            'V≈©ng T√†u': '790000' // Alternative name
        };

        // Helper function to get postal code by province name
        function getPostalCode(provinceName) {
            if (!provinceName || provinceName.trim() === '') {
                return '';
            }

            // Clean and normalize the province name
            const cleanName = provinceName.trim();

            // Direct lookup
            if (POSTAL_CODES[cleanName]) {
                return POSTAL_CODES[cleanName];
            }

            // Try fuzzy matching - remove common prefixes/suffixes
            const normalizedName = cleanName
                .replace(/^(T·ªânh|Th√†nh ph·ªë|TP\.?)\s+/i, '')
                .replace(/\s+(T·ªânh|Th√†nh ph·ªë|TP)$/i, '')
                .trim();

            if (POSTAL_CODES[normalizedName]) {
                return POSTAL_CODES[normalizedName];
            }

            // Try partial matching
            for (const [key, value] of Object.entries(POSTAL_CODES)) {
                if (key.includes(normalizedName) || normalizedName.includes(key)) {
                    return value;
                }
            }

            return '';
        }

        // Helper function to split Vietnamese address
        function splitVietnameseAddress(address) {
            if (!address || address.trim() === '') {
                return { thonXom: '', huyenQuan: '', tinhThanhPho: '' };
            }

            const addressParts = address.trim().split(',').map(part => part.trim());

            if (addressParts.length === 1) {
                // Only one part - treat as thon xom
                return { thonXom: addressParts[0], huyenQuan: '', tinhThanhPho: '' };
            } else if (addressParts.length === 2) {
                // Two parts - last is tinh/thanh pho, first is everything else
                return {
                    thonXom: addressParts[0],
                    huyenQuan: '',
                    tinhThanhPho: addressParts[1]
                };
            } else {
                // Three or more parts - last is tinh/thanh pho, second last is huyen/quan, rest is thon xom
                const tinhThanhPho = addressParts[addressParts.length - 1];
                const huyenQuan = addressParts[addressParts.length - 2];
                const thonXom = addressParts.slice(0, -2).join(', ');
                return { thonXom, huyenQuan, tinhThanhPho };
            }
        }

        // Export Functions
        function toggleCSVDropdown() {
            const dropdown = document.getElementById('csvDropdown');
            const isVisible = dropdown.style.display === 'block';
            dropdown.style.display = isVisible ? 'none' : 'block';

            // Close Excel dropdown if open
            document.getElementById('excelDropdown').style.display = 'none';

            // Close dropdown when clicking outside
            if (!isVisible) {
                setTimeout(() => {
                    document.addEventListener('click', closeCSVDropdownOnClickOutside);
                }, 0);
            }
        }

        function toggleExcelDropdown() {
            const dropdown = document.getElementById('excelDropdown');
            const isVisible = dropdown.style.display === 'block';
            dropdown.style.display = isVisible ? 'none' : 'block';

            // Close CSV dropdown if open
            document.getElementById('csvDropdown').style.display = 'none';

            // Close dropdown when clicking outside
            if (!isVisible) {
                setTimeout(() => {
                    document.addEventListener('click', closeExcelDropdownOnClickOutside);
                }, 0);
            }
        }

        function closeCSVDropdownOnClickOutside(event) {
            const dropdown = document.getElementById('csvDropdown');
            const button = document.getElementById('csvDropdownBtn');

            if (!dropdown.contains(event.target) && !button.contains(event.target)) {
                dropdown.style.display = 'none';
                document.removeEventListener('click', closeCSVDropdownOnClickOutside);
            }
        }

        function closeExcelDropdownOnClickOutside(event) {
            const dropdown = document.getElementById('excelDropdown');
            const button = document.getElementById('excelDropdownBtn');

            if (!dropdown.contains(event.target) && !button.contains(event.target)) {
                dropdown.style.display = 'none';
                document.removeEventListener('click', closeExcelDropdownOnClickOutside);
            }
        }

        // Legacy function for backward compatibility
        function toggleExportDropdown() {
            toggleCSVDropdown();
        }

        function closeExportDropdownOnClickOutside(event) {
            closeCSVDropdownOnClickOutside(event);
        }

        function exportAllToCSV() {
            if (selectedImages.length === 0) {
                showAlert('Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t!', 'error');
                return;
            }

            const headers = [
                'T√™n folder (g√≥i c∆∞·ªõc)', 'H·ªç v√† T√™n ƒë·∫ßy ƒë·ªß', 'Ng√†y th√°ng nƒÉm sinh', 'S·ªë CCCD',
                'ƒê·ªãa ch·ªâ th√¥n x√≥m cho t·ªïi x√£ ph∆∞·ªùng theo n∆°i ƒëƒÉng k√Ω th∆∞·ªùng tr√∫',
                'Huy·ªán, Qu·∫≠n, th√†nh ph·ªë tr·ª±c thu·ªôc t·ªânh, theo n∆°i ƒëƒÉng k√Ω th∆∞·ªùng tr√∫',
                'Th√†nh ph·ªë, T·ªânh',
                'Post code b∆∞u ƒëi·ªán c·ªßa kh√°ch h√†ng theo t·ªânh',
                'H·ªç', 'T√™n ƒë·ªám', 'T√™n'
            ];

            const csvContent = [
                headers.join(','),
                ...selectedImages.map((img, index) => {
                    const nameInfo = splitVietnameseName(img.fullName);
                    const addressInfo = splitVietnameseAddress(img.residence);
                    const postalCode = getPostalCode(addressInfo.tinhThanhPho);
                    return [
                        `"${img.folderName || 'T·ªáp ƒë∆°n l·∫ª'}"`,
                        `"${img.fullName || ''}"`,
                        `"${img.dateOfBirth || ''}"`,
                        `"${img.idNumber || ''}"`,
                        `"${addressInfo.thonXom}"`,
                        `"${addressInfo.huyenQuan}"`,
                        `"${addressInfo.tinhThanhPho}"`,
                        `"${postalCode}"`,
                        `"${nameInfo.ho}"`,
                        `"${nameInfo.tenDem}"`,
                        `"${nameInfo.ten}"`
                    ].join(',');
                })
            ].join('\n');

            downloadCSV(csvContent, `cccd_all_data_${new Date().toISOString().slice(0, 10)}.csv`);
            showAlert(`File CSV ƒë√£ ƒë∆∞·ª£c xu·∫•t th√†nh c√¥ng v·ªõi ${selectedImages.length} b·∫£n ghi (t·∫•t c·∫£ d·ªØ li·ªáu)!`, 'success');
            document.getElementById('csvDropdown').style.display = 'none';
        }

        function exportSuccessToCSV() {
            const successImages = selectedImages.filter(img => img.status === 'completed');
            if (successImages.length === 0) {
                showAlert('Kh√¥ng c√≥ item th√†nh c√¥ng ƒë·ªÉ xu·∫•t!', 'error');
                return;
            }

            const headers = [
                'T√™n folder (g√≥i c∆∞·ªõc)', 'H·ªç v√† T√™n ƒë·∫ßy ƒë·ªß', 'Ng√†y th√°ng nƒÉm sinh', 'S·ªë CCCD',
                'ƒê·ªãa ch·ªâ th√¥n x√≥m cho t·ªïi x√£ ph∆∞·ªùng theo n∆°i ƒëƒÉng k√Ω th∆∞·ªùng tr√∫',
                'Huy·ªán, Qu·∫≠n, th√†nh ph·ªë tr·ª±c thu·ªôc t·ªânh, theo n∆°i ƒëƒÉng k√Ω th∆∞·ªùng tr√∫',
                'Th√†nh ph·ªë, T·ªânh',
                'Post code b∆∞u ƒëi·ªán c·ªßa kh√°ch h√†ng theo t·ªânh',
                'H·ªç', 'T√™n ƒë·ªám', 'T√™n'
            ];

            const csvContent = [
                headers.join(','),
                ...successImages.map((img, index) => {
                    const nameInfo = splitVietnameseName(img.fullName);
                    const addressInfo = splitVietnameseAddress(img.residence);
                    const postalCode = getPostalCode(addressInfo.tinhThanhPho);
                    return [
                        `"${img.folderName || 'T·ªáp ƒë∆°n l·∫ª'}"`,
                        `"${img.fullName || ''}"`,
                        `"${img.dateOfBirth || ''}"`,
                        `"${img.idNumber || ''}"`,
                        `"${addressInfo.thonXom}"`,
                        `"${addressInfo.huyenQuan}"`,
                        `"${addressInfo.tinhThanhPho}"`,
                        `"${postalCode}"`,
                        `"${nameInfo.ho}"`,
                        `"${nameInfo.tenDem}"`,
                        `"${nameInfo.ten}"`
                    ].join(',');
                })
            ].join('\n');

            downloadCSV(csvContent, `cccd_success_items_${new Date().toISOString().slice(0, 10)}.csv`);
            showAlert(`File CSV ƒë√£ ƒë∆∞·ª£c xu·∫•t th√†nh c√¥ng v·ªõi ${successImages.length} item th√†nh c√¥ng!`, 'success');
            document.getElementById('csvDropdown').style.display = 'none';
        }

        function exportFailedToCSV() {
            const failedImages = selectedImages.filter(img => img.status === 'error');
            if (failedImages.length === 0) {
                showAlert('Kh√¥ng c√≥ item failed ƒë·ªÉ xu·∫•t!', 'error');
                return;
            }

            const headers = [
                'T√™n file', 'K√≠ch th∆∞·ªõc', 'L·ªói', 'Th·ªùi gian x·ª≠ l√Ω', 'Tr·∫°ng th√°i'
            ];

            const csvContent = [
                headers.join(','),
                ...failedImages.map((img, index) => [
                    `"${img.name}"`,
                    `"${img.size}"`,
                    `"${img.fullName || 'L·ªói kh√¥ng x√°c ƒë·ªãnh'}"`,
                    `"${img.processedAt || ''}"`,
                    `"${getStatusText(img.status)}"`
                ].join(','))
            ].join('\n');

            downloadCSV(csvContent, `cccd_failed_items_${new Date().toISOString().slice(0, 10)}.csv`);
            showAlert(`File CSV ƒë√£ ƒë∆∞·ª£c xu·∫•t th√†nh c√¥ng v·ªõi ${failedImages.length} item failed!`, 'success');
            document.getElementById('csvDropdown').style.display = 'none';
        }

        function downloadCSV(csvContent, filename) {
            // Add BOM for proper UTF-8 encoding in Excel
            const BOM = '\uFEFF';
            const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });

            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';

            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        // Excel Export Functions
        function exportAllToExcel() {
            if (selectedImages.length === 0) {
                showAlert('Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t!', 'error');
                return;
            }

            const headers = [
                'T√™n folder (g√≥i c∆∞·ªõc)', 'H·ªç v√† T√™n ƒë·∫ßy ƒë·ªß', 'Ng√†y th√°ng nƒÉm sinh', 'S·ªë CCCD',
                'ƒê·ªãa ch·ªâ th√¥n x√≥m cho t·ªïi x√£ ph∆∞·ªùng theo n∆°i ƒëƒÉng k√Ω th∆∞·ªùng tr√∫',
                'Huy·ªán, Qu·∫≠n, th√†nh ph·ªë tr·ª±c thu·ªôc t·ªânh, theo n∆°i ƒëƒÉng k√Ω th∆∞·ªùng tr√∫',
                'Th√†nh ph·ªë, T·ªânh',
                'Post code b∆∞u ƒëi·ªán c·ªßa kh√°ch h√†ng theo t·ªânh',
                'H·ªç', 'T√™n ƒë·ªám', 'T√™n'
            ];

            const data = [
                headers,
                ...selectedImages.map((img, index) => {
                    const nameInfo = splitVietnameseName(img.fullName);
                    const addressInfo = splitVietnameseAddress(img.residence);
                    const postalCode = getPostalCode(addressInfo.tinhThanhPho);
                    return [
                        img.folderName || 'T·ªáp ƒë∆°n l·∫ª',
                        img.fullName || '',
                        img.dateOfBirth || '',
                        img.idNumber || '',
                        addressInfo.thonXom,
                        addressInfo.huyenQuan,
                        addressInfo.tinhThanhPho,
                        postalCode,
                        nameInfo.ho,
                        nameInfo.tenDem,
                        nameInfo.ten
                    ];
                })
            ];

            downloadExcel(data, `cccd_all_data_${new Date().toISOString().slice(0, 10)}.xlsx`, 'T·∫•t c·∫£ d·ªØ li·ªáu CCCD');
            showAlert(`File Excel ƒë√£ ƒë∆∞·ª£c xu·∫•t th√†nh c√¥ng v·ªõi ${selectedImages.length} b·∫£n ghi (t·∫•t c·∫£ d·ªØ li·ªáu)!`, 'success');
            document.getElementById('excelDropdown').style.display = 'none';
        }

        function exportSuccessToExcel() {
            const successImages = selectedImages.filter(img => img.status === 'completed');
            if (successImages.length === 0) {
                showAlert('Kh√¥ng c√≥ item th√†nh c√¥ng ƒë·ªÉ xu·∫•t!', 'error');
                return;
            }

            const headers = [
                'T√™n folder (g√≥i c∆∞·ªõc)', 'H·ªç v√† T√™n ƒë·∫ßy ƒë·ªß', 'Ng√†y th√°ng nƒÉm sinh', 'S·ªë CCCD',
                'ƒê·ªãa ch·ªâ th√¥n x√≥m cho t·ªïi x√£ ph∆∞·ªùng theo n∆°i ƒëƒÉng k√Ω th∆∞·ªùng tr√∫',
                'Huy·ªán, Qu·∫≠n, th√†nh ph·ªë tr·ª±c thu·ªôc t·ªânh, theo n∆°i ƒëƒÉng k√Ω th∆∞·ªùng tr√∫',
                'Th√†nh ph·ªë, T·ªânh',
                'Post code b∆∞u ƒëi·ªán c·ªßa kh√°ch h√†ng theo t·ªânh',
                'H·ªç', 'T√™n ƒë·ªám', 'T√™n'
            ];

            const data = [
                headers,
                ...successImages.map((img, index) => {
                    const nameInfo = splitVietnameseName(img.fullName);
                    const addressInfo = splitVietnameseAddress(img.residence);
                    const postalCode = getPostalCode(addressInfo.tinhThanhPho);
                    return [
                        img.folderName || 'T·ªáp ƒë∆°n l·∫ª',
                        img.fullName || '',
                        img.dateOfBirth || '',
                        img.idNumber || '',
                        addressInfo.thonXom,
                        addressInfo.huyenQuan,
                        addressInfo.tinhThanhPho,
                        postalCode,
                        nameInfo.ho,
                        nameInfo.tenDem,
                        nameInfo.ten
                    ];
                })
            ];

            downloadExcel(data, `cccd_success_items_${new Date().toISOString().slice(0, 10)}.xlsx`, 'Item th√†nh c√¥ng CCCD');
            showAlert(`File Excel ƒë√£ ƒë∆∞·ª£c xu·∫•t th√†nh c√¥ng v·ªõi ${successImages.length} item th√†nh c√¥ng!`, 'success');
            document.getElementById('excelDropdown').style.display = 'none';
        }

        function exportFailedToExcel() {
            const failedImages = selectedImages.filter(img => img.status === 'error');
            if (failedImages.length === 0) {
                showAlert('Kh√¥ng c√≥ item failed ƒë·ªÉ xu·∫•t!', 'error');
                return;
            }

            const headers = [
                'T√™n file', 'K√≠ch th∆∞·ªõc', 'L·ªói', 'Th·ªùi gian x·ª≠ l√Ω', 'Tr·∫°ng th√°i'
            ];

            const data = [
                headers,
                ...failedImages.map((img, index) => [
                    img.name,
                    img.size,
                    img.fullName || 'L·ªói kh√¥ng x√°c ƒë·ªãnh',
                    img.processedAt || '',
                    getStatusText(img.status)
                ])
            ];

            downloadExcel(data, `cccd_failed_items_${new Date().toISOString().slice(0, 10)}.xlsx`, 'Item failed CCCD');
            showAlert(`File Excel ƒë√£ ƒë∆∞·ª£c xu·∫•t th√†nh c√¥ng v·ªõi ${failedImages.length} item failed!`, 'success');
            document.getElementById('excelDropdown').style.display = 'none';
        }

        function downloadExcel(data, filename, sheetName = 'Sheet1') {
            // Create workbook and worksheet
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(data);

            // Auto-adjust column widths
            const colWidths = [];
            data[0].forEach((header, colIndex) => {
                let maxWidth = header.length;
                for (let rowIndex = 1; rowIndex < data.length; rowIndex++) {
                    const cellValue = data[rowIndex][colIndex];
                    if (cellValue && cellValue.toString().length > maxWidth) {
                        maxWidth = cellValue.toString().length;
                    }
                }
                colWidths.push({ wch: Math.min(maxWidth + 2, 50) }); // Max width 50, min +2 padding
            });
            ws['!cols'] = colWidths;

            // Style header row
            const headerStyle = {
                fill: { bgColor: { indexed: 64 }, fgColor: { rgb: "4472C4" } },
                font: { bold: true, color: { rgb: "FFFFFF" } },
                alignment: { horizontal: "center", vertical: "center" }
            };

            // Apply header style to first row
            for (let col = 0; col < data[0].length; col++) {
                const cellAddress = XLSX.utils.encode_cell({ r: 0, c: col });
                if (!ws[cellAddress]) continue;
                ws[cellAddress].s = headerStyle;
            }

            // Add worksheet to workbook
            XLSX.utils.book_append_sheet(wb, ws, sheetName);

            // Write file
            XLSX.writeFile(wb, filename);
        }

        // Legacy function for backward compatibility
        function exportToCSV() {
            exportSuccessToCSV();
        }

        // Donate Modal Functions
        function openDonateModal() {
            document.getElementById('donateModal').style.display = 'block';
            document.body.style.overflow = 'hidden'; // Prevent background scrolling
        }

        function closeDonateModal() {
            document.getElementById('donateModal').style.display = 'none';
            document.body.style.overflow = 'auto'; // Restore scrolling
        }

        // Close modal when clicking outside of it
        window.onclick = function (event) {
            const modal = document.getElementById('donateModal');
            if (event.target == modal) {
                closeDonateModal();
            }
        }

        // Close modal with Escape key
        document.addEventListener('keydown', function (event) {
            if (event.key === 'Escape') {
                closeDonateModal();
            }
        });
    </script>
    <script defer src="./init-firebase.js"></script>

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-8LGRB7QB8J"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());

        gtag('config', 'G-8LGRB7QB8J');
    </script>

    <!-- Donate Modal -->
    <div id="donateModal" class="donate-modal">
        <div class="donate-modal-content">
            <div class="donate-modal-title">·ª¶ng h·ªô d·ª± √°n</div>
            <div class="donate-modal-description">
                C·∫£m ∆°n b·∫°n ƒë√£ quan t√¢m v√† ·ªßng h·ªô d·ª± √°n! M·ªçi ƒë√≥ng g√≥p c·ªßa b·∫°n s·∫Ω gi√∫p duy tr√¨ v√† ph√°t tri·ªÉn ·ª©ng d·ª•ng.
            </div>

            <div class="donate-qr-container">
                <img src="https://img.vietqr.io/image/acb-42795707-qr_only.png?fullname=DO%20VAN%20TU"
                    alt="QR Code chuy·ªÉn kho·∫£n" />
            </div>

            <div class="donate-bank-info">
                <div class="donate-bank-name">üè¶ Th√¥ng tin chuy·ªÉn kho·∫£n</div>
                <div class="donate-account-info">
                    <strong>Ng√¢n h√†ng:</strong> ACB (Ng√¢n h√†ng √Å Ch√¢u)<br>
                    <strong>S·ªë t√†i kho·∫£n:</strong> 42795707<br>
                    <strong>Ch·ªß t√†i kho·∫£n:</strong> DO VAN TU<br>
                </div>
            </div>

            <div class="donate-modal-actions">
                <button class="donate-close" onclick="closeDonateModal()">ƒê√≥ng</button>
            </div>
        </div>
    </div>
</body>

</html>